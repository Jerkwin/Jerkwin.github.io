function trim(a){return a.replace(/^(\s|\u00A0)+/,"").replace(/(\s|\u00A0)+$/,"")}function norm(a){return a.replace(/^\s*\n*/,"").replace(/\s*\n*$/,"").replace(/\s+[\n|$]/g,"\n")}function noShow(a){$(a).style.display="none"}function printf(){var a={s:function(a,b){return b*=1,m=Array(Math.max(Math.abs(b)-a.length+1,0)).join(" "),b>0?m+a:a+m},f:function(a,b){return b=b.split("."),a=parseFloat(a).toFixed(b[1]),m=Array(Math.max(Math.abs(b[0])-a.length+1,0)).join(" "),b[0]>0?m+a:a+m}},b=Array.prototype.slice.call(arguments).slice();return(""+b.shift()).replace(/%(-*\d*\.*\d*)([sf])/g,function(c,d,e){if(!b.length)throw Error("Too few elements");return a[e](b.shift(),d)})}function autoType(){var i,j,retTxt,src,mol=Mol(),n=mol[0].numatoms-4*mol[0].pbc,adj=BondMatrix(),txt="";for(i=1;n>=i;i++){for(txt+=i+" "+element(mol[i].atomicnumber,"symbol"),j=1;n>=j;j++)j!=i&&adj[i][j]&&(txt+=" "+j);txt+="\n"}retTxt="",p5typeglob_set("Perlito5::IO","print",function(a,b){if("STDOUT"==a||"main::STDOUT"==a)for(var c=0;c<b.length;c++)retTxt+=p5str(b[c])}),p5pkg["main"]["v_^O"]="browser",p5pkg["main"]["Hash_INC"]["Perlito5X/strict.pm"]="Perlito5X/strict.pm",p5pkg["main"]["Hash_INC"]["Perlito5X/warnings.pm"]="Perlito5X/warnings.pm",p5pkg["main"]["Hash_INC"]["Perlito5X/feature.pm"]="Perlito5X/feature.pm",src="$txt='"+txt+"';"+document.getElementById("src").value;try{src=p5pkg["Perlito5"].compile_p5_to_js([src]),eval(src),InfoWin("AUTO Assign: "+retTxt,1)}catch(err){alert(err)}for(txt=retTxt.split("|"),i=1;n>=i;i++)src=txt[i].split(/\s+/),src.length>2&&(mol[i].type="opls"+src[1]);setATP()}function readSTRfile(a,b){for(var c,e,m,l,n,o,f=Mol(),g=f[0].numatoms-4*f[0].pbc,h=.1,i=4.184,j=2*i,k=j/(h*h),d=0;!b[d].match(/^ *ATOM/);)d++;for(c=1;g>=c;c++)e=trim(b[d+c-1]).split(/\s+/),f[c].type=e[2],f[c].charge=e[3];for(typFF="CHARMM",setATP(),impCHARMM="	[ dihedrals ]\n",d=c,g=b.length,c=d;g>c&&(b[c]=trim(b[c]),!b[c].match(/^ *END/));c++)b[c].match(/^ *IMPR/)&&(e=trim(b[c].replace(/[^\d]/g," ")).split(/\s+/),impCHARMM+=printf("    %4f %4f %4f %4f    2\n",e[0],e[1],e[2],e[3]));for(d=c;!b[d].match(/^ *read param card flex append/);)d++;for(bontypes="[ bondtypes ]\n  ; i       j        fun     b0        kb\n",angtypes="[ angletypes ]\n  ; i        j        k       fun   theta0        ktheta          ub0          kub\n",dihtypes="[ dihedraltypes ]\n  ; i        j        k        l       fun   phi0            kphi      mult\n",imptypes="[ dihedraltypes ]\n  ; improper\n  ; i        j        k        l  func         phi0         kphi\n",dihPar=[],l=[],g=b.length,type=1,c=d;g>c&&(b[c]=trim(b[c]),!b[c].match(/^ *END/));c++)b[c].match(/^ *BONDS/)?type=2:b[c].match(/^ *ANGLES/)?type=3:b[c].match(/^ *DIHEDRALS/)?type=4:b[c].match(/^ *IMPROPERS/)?type=5:b[c].length>0&&(e=trim(b[c].replace(/!.*/g,"")).split(/\s+/),2==type?bontypes+=printf("  %-8s %-8s   1 %12.6f %12.6f  %s\n",e[0],e[1],parseFloat(e[3])*h,parseFloat(e[2])*k,b[c].replace(/^.+!/,";")):3==type?(n=0,o=0,e.length>5&&(n=e[6],o=e[5]),angtypes+=printf("  %-8s %-8s %-8s   5  %12.6f  %12.6f  %12.6f  %12.6f  %s\n",e[0],e[1],e[2],parseFloat(e[4]),parseFloat(e[3])*j,parseFloat(n)*h,parseFloat(o)*k,b[c].replace(/^.+!/,";"))):4==type?(e[1]==e[2]?(l=[e[0],e[3]],l.sort(),l=["|",l[0],e[1],e[2],l[1]]):(l=[e[1],e[2]],l.sort(),l=e[1]<e[2]?["|",e[0],e[1],e[2],e[3]]:["|",e[3],e[2],e[1],e[0]]),l="|"+l[1]+"|"+l[2]+"|"+l[3]+"|"+l[4]+"|",m=printf("    9  %12.6f  %12.6f   %-4s@#@",parseFloat(e[6]),parseFloat(e[4])*i,e[5]),dihPar[l]?dihPar[l]+=m:dihPar[l]=m,dihtypes+=printf("  ;%-8s %-8s %-8s %-8s   9  %12.6f  %12.6f   %-4s  %s\n",e[0],e[1],e[2],e[3],parseFloat(e[6]),parseFloat(e[4])*i,e[5],b[c].replace(/^.+!/,";"))):5==type&&(imptypes+=printf("  %-8s %-8s %-8s %-8s   2  %12.6f  %12.6f  %s\n",e[0],e[1],e[2],e[3],parseFloat(e[5]),parseFloat(e[4])*j,b[c].replace(/^.+!/,";"))));bontypes+="\n",angtypes+="\n",dihtypes+="\n",imptypes+="\n"}function initCanvas(){window.addEventListener("resize",resizeCanvas,!1),resizeCanvas()}function resizeCanvas(){var a=$("molcanvas");a.width=.78*(document.body.clientWidth||window.innerWidth),a.height=.65*(document.body.clientHeight||window.innerHeight),drawMolecule(),resetView()}function initDragbox(){function f(){a=!1,document.body.classList.remove("no-select"),dragCon.classList.remove("pointer-events"),dragBox.style.opacity=1}var a,b,c,d=window.innerWidth,e=window.innerHeight;dragBar.addEventListener("mousedown",function(d){a=!0,document.body.classList.add("no-select"),dragCon.classList.add("pointer-events"),b=d.offsetX,c=d.offsetY,dragBox.style.opacity=.5}),dragBar.onmouseup=f,document.addEventListener("mousemove",function(f){if(a){var g=dragBox.offsetWidth,h=dragBox.offsetHeight,i=dragBar.offsetHeight,j=Math.max(f.clientX-b,0),k=Math.max(f.clientY-c,0);f.clientX>d+b-g-16&&(j=d-g),f.clientY>e+c-h-i&&(k=e-h-i),dragBox.style.left=j+"px",dragBox.style.top=k+"px"}}),document.addEventListener("mouseup",function(){f()})}function genTop(){for(var b,c,d,f,g,h,i,p,q,j=[],k=[],l=0,m=Mol(),n=m[0].numatoms-4*m[0].pbc,o=BondMatrix(),e=norm($("atp2").value).split("\n"),a=e.length;a--;)e[a]=trim(e[a]).split(/\s+/)[1];if("CHARMM"==typFF)g='#include "charmm36.ff/forcefield.itp"\n\n'+bontypes+angtypes+dihtypes+imptypes+'\n#include "charmm36.ff/tip3p.itp"\n#include "charmm36.ff/ions.itp"\n\n\n';else{for(g=';#include "oplsaa.ff/forcefield.itp"\n;#include "oplsaa.ff/tip3p.itp"\n\n[ defaults ]\n  ;nbfunc  comb-rule  gen-pairs  fudgeLJ  fudgeQQ\n    1        3          yes        0.5      0.5\n\n[ atomtypes ]\n  ;type         mass          charge   ptype   sigma        epsilon\n',def=uniq(e),a=0;a<def.length;a++)i=def[a],atpMas[i]||(i="USR"),g+=printf("  %s    %10.6f    %8.4f    %s    %10.7f   %10.7f\n",def[a],atpMas[i],atpChg[i],atpAtm[i],atpSgm[i],atpEps[i]);g+="\n"}for(h="",a=1;n>=a;a++){if(i=e[a-1],i==m[a].type||p||(p=confirm("!!! WARNING !!!\n\n    Type of Atom #"+a+" NOT Consistent with Your Assignments !\n"+"Readin: "+e[a-1]+"\nAssign: "+i+"\n\nWill Use Readin Type to Continue.")),0==p)return;atpMas[i]?k[a]=atpLab[i]:(i="USR",k[a]=e[a-1]),"CHARMM"==typFF?(l+=parseFloat(m[a].charge),h+=printf("    %4f %-10s  1  MOL  %-10s %4f  %8.4f    ; qtot=%8.4f\n",a,e[a-1],k[a],a,m[a].charge,l)):(l+=parseFloat(atpChg[i]),h+=printf("    %4f %-10s  1  MOL  %-4s %4f ; %8.4f %10.6f    ; qtot=%8.4f [%-3s] %s\n",a,e[a-1],k[a],a,atpChg[i],atpMas[i],l,k[a],trim(atpTip[i].substr(1))))}for(def=[],excs=[],a=1;n>=a;a++)for(b=a+1;n>=b;b++)if(o[a][b]&&(pair=[k[a],k[b]],pair.sort(),pair=["|",pair[0],pair[1]],i="|"+pair[1]+"|"+pair[2]+"|",excs.push(printf("    %4f %4f",a,b)),!def[i])){maxMatch=0;for(e in bonPar)para=e.split("|"),maxMatch=Math.max(maxMatch,matchLev(para[1],pair[1])+matchLev(para[2],pair[2]),matchLev(para[1],pair[2])+matchLev(para[2],pair[1]));if(0==maxMatch)def[i]="; !!! NO Match !!!";else{def[i]="!!! NO Exact Match !!!@#@",18==maxMatch&&(def[i]="");for(e in bonPar)para=e.split("|"),(maxMatch==matchLev(para[1],pair[1])+matchLev(para[2],pair[2])||maxMatch==matchLev(para[1],pair[2])+matchLev(para[2],pair[1]))&&(def[i]+=bonPar[e]+" ;"+maxMatch+e+"@#@")}}for(b=1;n>=b;b++)for(a=1;n>=a;a++)if(o[a][b]&&a!=b)for(c=a+1;n>=c;c++)if(o[b][c]&&c!=a&&c!=b&&(pair=[k[a],k[c]],pair.sort(),pair=["|",pair[0],k[b],pair[1]],i="|"+pair[1]+"|"+pair[2]+"|"+pair[3]+"|",excs.push(printf("    %4f %4f",Math.min(a,b),Math.max(a,b))),excs.push(printf("    %4f %4f",Math.min(a,c),Math.max(a,c))),excs.push(printf("    %4f %4f",Math.min(b,c),Math.max(b,c))),!def[i])){maxMatch=0;for(e in angPar)para=e.split("|"),maxMatch=Math.max(maxMatch,100*matchLev(para[2],pair[2])+matchLev(para[1],pair[1])+matchLev(para[3],pair[3]),100*matchLev(para[2],pair[2])+matchLev(para[1],pair[3])+matchLev(para[3],pair[1]));if(0==maxMatch)def[i]="; !!! NO Match !!!";else{def[i]="!!! NO Exact Match !!!@#@",918==maxMatch&&(def[i]="");for(e in angPar)para=e.split("|"),(maxMatch==100*matchLev(para[2],pair[2])+matchLev(para[1],pair[3])+matchLev(para[3],pair[1])||maxMatch==100*matchLev(para[2],pair[2])+matchLev(para[1],pair[1])+matchLev(para[3],pair[3]))&&(def[i]+=angPar[e]+" ;"+maxMatch+e+"@#@")}}for(b=1;n>=b;b++)for(c=b+1;n>=c;c++)if(o[b][c])for(a=1;n>=a;a++)if(o[a][b]&&a!=b&&a!=c)for(d=1;n>=d;d++)if(o[d][c]&&d!=a&&d!=b&&d!=c&&(k[b]==k[c]?(pair=[k[a],k[d]],pair.sort(),pair=["|",pair[0],k[b],k[c],pair[1]]):(pair=[k[b],k[c]],pair.sort(),pair=k[b]<k[c]?["|",k[a],k[b],k[c],k[d]]:["|",k[d],k[c],k[b],k[a]]),i="|"+pair[1]+"|"+pair[2]+"|"+pair[3]+"|"+pair[4]+"|",excs.push(printf("    %4f %4f",Math.min(a,b),Math.max(a,b))),excs.push(printf("    %4f %4f",Math.min(a,c),Math.max(a,c))),excs.push(printf("    %4f %4f",Math.min(b,c),Math.max(b,c))),excs.push(printf("    %4f %4f",Math.min(b,d),Math.max(b,d))),excs.push(printf("    %4f %4f",Math.min(c,d),Math.max(c,d))),!def[i])){maxMatch=0;for(e in dihPar)para=e.split("|"),maxMatch=Math.max(maxMatch,matchLev(para[1],pair[1])+100*matchLev(para[2],pair[2])+100*matchLev(para[3],pair[3])+matchLev(para[4],pair[4]),matchLev(para[1],pair[4])+100*matchLev(para[2],pair[3])+100*matchLev(para[3],pair[2])+matchLev(para[4],pair[1]));if(0==maxMatch)def[i]="; !!! NO Match !!!";else{def[i]="!!! NO Exact Match !!!@#@",1818==maxMatch&&(def[i]="");for(e in dihPar)para=e.split("|"),(maxMatch==matchLev(para[1],pair[1])+100*matchLev(para[2],pair[2])+100*matchLev(para[3],pair[3])+matchLev(para[4],pair[4])||maxMatch==matchLev(para[1],pair[4])+100*matchLev(para[2],pair[3])+100*matchLev(para[3],pair[2])+matchLev(para[4],pair[1]))&&(def[i]+=dihPar[e]+" ;"+maxMatch+e+"@#@")}}for(f="",a=1;n>=a;a++){for(e="",b=1;n>=b;b++)if(o[a][b]&&"N2"==k[b]){for(c=1;n>=c;c++)o[a][c]&&c!=a&&c!=b&&"N2"==k[c]&&(e+=printf("%4f ",c));i="improper_N2_X_N2_N2",def["|"+i+"|"]=defPar[i]+"@#@",f+=printf("    %s%4f %4f  4  %s\n",e,a,b,i)}for(e="",b=1;n>=b;b++)j[b]=1;if("C"==k[a]||"C_2"==k[a]||"C_3"==k[a]){for(b=1;n>=b;b++)if(o[a][b]&&("O"==k[b]||"O_2"==k[b])){for(c=1;n>=c;c++)o[a][c]&&c!=a&&c!=b&&(e+=printf("%4f ",c));i="improper_O_C_X_Y",def["|"+i+"|"]=defPar[i]+"@#@",f+=printf("    %s%4f %4f  4  %s\n",e,a,b,i)}}else if("NO"==k[a]){for(b=1;n>=b;b++)if(o[a][b]&&"ON"!=k[b]){for(c=1;n>=c;c++)o[a][c]&&c!=a&&c!=b&&"ON"==k[c]&&(e+=printf("%4f ",c));i="improper_X_NO_ON_NO",def["|"+i+"|"]=defPar[i]+"@#@",f+=printf("    %s%4f %4f  4  %s\n",e,a,b,i)}}else if("N"==k[a]||"CM"==k[a]||"C="==k[a]||"CA"==k[a]||"CB"==k[a]||"CN"==k[a]||"CV"==k[a]||"CW"==k[a]||"CR"==k[a]||"CK"==k[a]||"CQ"==k[a]||"CS"==k[a]||"C*"==k[a])for(b=1;n>=b;b++)if(j[b]&&o[a][b]){for(j[b]=0,ninc=0,c=1;n>=c;c++)o[a][c]&&c!=a&&c!=b&&(j[c]=0,ninc++,e+=printf("%4f ",c));ninc==2&&(i="improper_Z_CA_X_Y","N"==k[a]?i="improper_Z_N_X_Y":("CM"==k[a]||"C="==k[a])&&(i="improper_Z_CM_X_Y"),def["|"+i+"|"]=defPar[i]+"@#@",f+=printf("    %s%4f %4f  4  %s\n",e,a,b,i))}}if(g+="[ moleculetype ]\n  ;name  nrexcl\n  MOL    3\n","CHARMM"==typFF)g+="\n	[ atoms ]\n    ;  #  type    res#  res  atom        cg#    charge      qtot\n";else{for(e in def)if(para=uniq(def[e].split("@#@")),def[e]=para[1],para.length>2)for(def[e]=para[2],a=3;a<para.length;a++)def[e]+=printf("\n%-34s;","")+para[a];for(e in def)g+="\n	#define "+printf("%-25s ",e.slice(1,-1).replace(/\|/g,"_"))+def[e]+"\n";g+="\n	[ atoms ]\n    ;  #  type    res#  res  atom  cg# ;   charge   mass        ; qtot          comment\n"}for(g+=h,def=[],$("sortTop").checked||(g+="	[ bonds ]\n"),a=1;n>=a;a++)for(b=a+1;n>=b;b++)o[a][b]&&(pair=[k[a],k[b]],pair.sort(),pair=pair[0]+"_"+pair[1],"CHARMM"==typFF&&(pair="    1  ; "+pair),i=printf("    %4f %4f    %s\n",a,b,pair),$("sortTop").checked?def[pair]?def[pair]+=i:def[pair]=i:g+=i);if($("sortTop").checked){g+="	[ bonds ]    ;"+getObjLength(def)+"\n";for(e in def)g+=printf("		;[ HAR ]  %4f    FIT  0 0    %s",def[e].split("\n").length-1,e+"\n"+def[e])}for(def=[],$("sortTop").checked||(g+="	[ angles ]\n"),b=1;n>=b;b++)for(a=1;n>=a;a++)if(o[a][b]&&a!=b)for(c=a+1;n>=c;c++)o[b][c]&&c!=a&&c!=b&&(pair=[k[a],k[c]],pair.sort(),pair=pair[0]+"_"+k[b]+"_"+pair[1],"CHARMM"==typFF&&(pair="    5  ; "+pair),i=printf("    %4f %4f %4f    %s\n",a,b,c,pair),$("sortTop").checked?def[pair]?def[pair]+=i:def[pair]=i:g+=i);if($("sortTop").checked){g+="	[ angles ]    ;"+getObjLength(def)+"\n";for(e in def)g+=printf("		;[ HAR ]  %4f    FIT  0 0    %s",def[e].split("\n").length-1,e+"\n"+def[e])}for(def=[],pairs=[],$("sortTop").checked||(g+="	[ dihedrals ]\n"),b=1;n>=b;b++)for(c=b+1;n>=c;c++)if(o[b][c])for(a=1;n>=a;a++)if(o[a][b]&&a!=b&&a!=c)for(d=1;n>=d;d++)if(o[d][c]&&d!=a&&d!=b&&d!=c){if(k[b]==k[c]?(pair=[k[a],k[d]],pair.sort(),pair=["|",pair[0],k[b],k[c],pair[1]]):(pair=[k[b],k[c]],pair.sort(),pair=k[b]<k[c]?["|",k[a],k[b],k[c],k[d]]:["|",k[d],k[c],k[b],k[a]]),pair=pair[1]+"_"+pair[2]+"_"+pair[3]+"_"+pair[4],"CHARMM"==typFF)if(pair="|"+pair.replace(/_/g,"|")+"|",pair in dihPar)for(e=trim(dihPar[pair]).split(/@#@/),pair=trim(e[0])+"  ; "+pair,q=1;q<e.length-1;q++)pair+=printf("\n    %4f %4f %4f %4f    %s",a,b,c,d,trim(e[q]));else pair="9  ; "+pair;i=printf("    %4f %4f %4f %4f    %s\n",a,b,c,d,pair),$("sortTop").checked?def[pair]?def[pair]+=i:def[pair]=i:g+=i,pairs.push(printf("    %4f %4f %4f",Math.min(a,d),Math.max(a,d),1))}if($("sortTop").checked){g+="	[ dihedrals ]    ;"+getObjLength(def)+"\n";for(e in def)g+=printf("		;[ COS ]  %4f    FIT  0  1  0    %s",def[e].split("\n").length-1,e+"\n"+def[e])}"CHARMM"==typFF&&(f=impCHARMM),g+=f,g+="	[ exclusions ]\n"+uniq(excs).join("\n"),g+="\n	[ pairs ]\n"+uniq(pairs).join("\n"),g+="\n\n[ system ]\n  MOL OPLS\n",g+="	[ molecules ]\n      MOL    1\n",$("top").value=g}function getObjLength(a){var b=0;for(c in a)b++;return b}function uniq(a){var e,d,b=[],c={};for(d=0;null!=(e=a[d]);d++)c[e]||(b.push(e),c[e]=!0);return b.sort()}function matchLev(a,b){var c=0;return a.substring(0,1)==b.substring(0,1)&&(c=1),(trim(a)==trim(b)||"X"==a)&&(c=9),c}function saveFile(a){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,b="",c="text",d="";if("gro"==a)if(d="conf.gro",g=Mol(),h=g[0].numatoms-4*g[0].pbc,b="MOL\n  "+h+"\n",g[0].pbc){for(i=[g[0].box[0][0],g[0].box[1][0],g[0].box[2][0]],j=[g[0].box[0][1],g[0].box[1][1],g[0].box[2][1]],k=[g[0].box[0][2],g[0].box[1][2],g[0].box[2][2]],e=3;e--;)i[e]*=.1,j[e]*=.1,k[e]*=.1;for(e=1;h>=e;e++)f=element(g[e].atomicnumber,"symbol"),/opls_\d+/.test(g[e].type)&&(f=atpLab[g[e].type]),f=trim(f),f=Array(7-f.length+1).join(" ")+f,uvw=[g[e].u,g[e].v,g[e].w],b+=printf("%-8s%-7s%5f%8.3f%8.3f%8.3f\n","    1MOL",f,e,dot(i,uvw),dot(j,uvw),dot(k,uvw));b+=printf("%12.6f %12.6f %12.6f %12.6f %12.6f %12.6f %12.6f %12.6f %12.6f\n",i[0],j[1],k[2],j[0],k[0],i[1],k[1],i[2],j[2])}else{for(l=0,m=0,n=0,o=0,p=0,q=0,e=1;h>=e;e++)l+=g[e].xi,m+=g[e].yi,n+=g[e].zi;for(l/=h,m/=h,n/=h,e=1;h>=e;e++)o=Math.max(o,Math.abs(g[e].xi-l)),p=Math.max(p,Math.abs(g[e].yi-m)),q=Math.max(q,Math.abs(g[e].zi-n));for(o+=10,p+=10,q+=10,e=1;h>=e;e++)f=element(g[e].atomicnumber,"symbol"),/opls_\d+/.test(g[e].type)&&(f=atpLab[g[e].type]),f=trim(f),f=Array(7-f.length+1).join(" ")+f,b+=printf("%-8s%-7s%5f%8.3f%8.3f%8.3f\n","    1MOL",f,e,(g[e].xi-l+o)/10,(g[e].yi-m+p)/10,(g[e].zi-n+q)/10);b+=printf("%12.6f %12.6f %12.6f\n",o/5,p/5,q/5)}else"mdp"==a?(d="grompp.mdp",b="integrator        = md\ndt                = 1E-3\nnsteps            = 1000\n\nnstcomm           = 1\ncomm-mode         = Linear\n\nnstxout           = 1\nnstvout           = 1\nnstfout           = 1\nnstlog            = 1\nnstenergy         = 1\nnstcalcenergy     = 1\nnstxout-compressed      = 1\ncompressed-x-precision  = 1000\n\nrlist             = 1\nnstlist           = 1\nns_type           = grid\ncutoff-scheme     = Verlet\n\npbc               = xyz\n\nrvdw              = 1\nrcoulomb          = 1\nvdw-type          = Cut-off\ncoulombtype       = PME\n\ngen_vel           = yes\ngen_temp          = 298.15\ngen-seed          = -1\n\ntcoupl            = nose-hoover\ntau_t             = 2\nref_t             = 298.15\ntc-grps           = system\n\npcoupl            = No\ntau-p             = 1\nref-p             = 1\ncompressibility   = 4.5E-5\nrefcoord-scaling  = No"):"top"==a&&(b=$("top").value,d="topol.top");"function"==typeof window.Blob?r=new Blob([b],{type:c}):(s=window.BlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder,t=new s,t.append(b),r=t.getBlob(c)),u=window.URL||window.webkitURL,v=u.createObjectURL(r),w=document.createElement("a"),"download"in w?(w.style.visibility="hidden",w.href=v,w.download=d,document.body.appendChild(w),x=document.createEvent("MouseEvents"),x.initEvent("click",!0,!0),w.dispatchEvent(x),document.body.removeChild(w)):navigator.msSaveBlob?navigator.msSaveBlob(r,d):location.href=v}function loadFF(){var a,b,c,d,e,g,i,j,h,f=norm($("atomtypes.atp").value).replace(/\t+/g," ");for(f=f.split("\n"),a=f.length,g=0;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&(g++,c=e.substring(0,e.indexOf(" ")),b=e.indexOf(";"),atpTip[c]=";",-1!=b&&(atpTip[c]=e.substring(b)));for(f=norm($("ffnonbonded.itp").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length,g=0;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&"#"!=e.substring(0,1)&&"["!=e.substring(0,1)&&(g++,e=e.split(/\s+/),c=e[0],atpLab[c]=e[1],atpNum[c]=e[2],atpMas[c]=e[3],atpChg[c]=e[4],atpAtm[c]=e[5],atpSgm[c]=e[6],atpEps[c]=e[7]);for(f=norm($("atomadj").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length,h=[];a--;)if(e=trim(f[a]),";"!=e.substring(0,1)){for(c=trim(e.substring(0,e.indexOf("["))),e=trim(e.substring(e.indexOf("]")+1)),"-"==e.substring(0,1)&&(e="@"+e.substring(1)),h=e.split("-"),e="",b=h.length;b--;)for(i=trim(h[b].replace(/[^\d]/g,"")),""==i&&(i=1),j=0;j<parseInt(i);j++)e+=trim(h[b].replace(/\d/g,""))+" ";atpAdj[c]=trim(e).split(/\s+/)}for(atpTip["USR"]="; User-defined Non-OPLSAA",atpLab["USR"]="USR",atpNum["USR"]=0,atpMas["USR"]=1,atpChg["USR"]=0,atpAtm["USR"]="A",atpSgm["USR"]=0,atpEps["USR"]=0,keyOPLS=Object.keys(atpNum).sort(),f=norm($("ffbonded.itp").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&"["!=e.substring(0,1)&&"#"!=e.substring(0,1)?(b=e.search(/\s+\d+\s+/),c=trim(e.substring(0,b)),d=trim(e.substring(b)),c=c.replace(/\s+/g,"|"),b=c.split("|").length,c="|"+c+"|",3==b?angPar[c]=d:4==b?dihPar[c]=d:2==b&&(2==trim(d.replace(/;.*/,"")).split(/\s+/).length?cstPar[c]=d:bonPar[c]=d)):"#define"==e.substring(0,7)&&(b=e.search(/\s+-*[\d]+/),c=trim(e.substring(7,b)),d=trim(e.substring(b)),defPar[c]=d)}function setATP(a){var b,c=[],d=Mol(),e=d[0].numatoms-4*d[0].pbc;for(b=1;e>=b;b++)c[b-1]=printf("%-4s %s",element(d[b].atomicnumber,"symbol")+b,d[b].type);for(a&&(c=c.sort(function(a,c){return a=a.replace(/\s.*/,""),c=c.replace(/\s.*/,""),b=a.replace(/[^\d]+/,""),e=c.replace(/[^\d]+/,""),a=a.replace(/\d+.*/,""),c=c.replace(/\d+.*/,""),a!=c?c>a?-1:a>c?1:0:parseInt(b)-parseInt(e)})),$("atp").innerHTML="",$("atp2").value="",b=0,e=c.length;e>b;b++)$("atp").innerHTML+="<option>"+c[b]+"</option>",$("atp2").value+=c[b]+"\n"}function showType(a){var b,c,d,h,e=Mol(),f=a,g=BondMatrix();if("SEL"==a){for(h=$("atp"),b=e[0].numatoms-4*e[0].pbc;b--;)e[b].highlite=0;for(b=h.length,f="";b--;)h.options[b].selected&&(c=h.options[b].text.replace(/opls_.*/g,"").replace(/[^\d]/g,""),a=c,f+=c+" ",e[c].highlite=1);drawMolecule()}for(Nadj=0,Sadj="",b=1;b<=e[0].numatoms-4*e[0].pbc;b++)g[b][a]&&(Nadj++,c=b,Sadj+=trim(element(e[b].atomicnumber,"symbol"))+" ");if(1==Nadj)for(Sadj="@"+trim(Sadj)+" ",b=1;b<=e[0].numatoms-4*e[0].pbc;b++)b!=a&&g[b][c]&&(Sadj+=trim(element(e[b].atomicnumber,"symbol"))+" ");for(Sadj=trim(Sadj).split(/\s+/),atpScore=[],arr=[],arrAdj=[],n=0,d=keyOPLS.length;d--;)if(name=keyOPLS[d],atpNum[name]==e[a].atomicnumber){for(arr=atpAdj[name].concat(),c=arr.length,isMatch=!1;c--;)-1!=arr[c].indexOf("@")&&(isMatch=!0);if(Iadj=arr.length,isMatch&&(Iadj=1),arrAdj=Sadj.concat(),b=arrAdj.length,!isMatch&&1==Nadj)for(;b--;)arrAdj[b]=-1==arrAdj[b].indexOf("@")?"":arrAdj[b].replace("@","");for(score=0,Iadj==Nadj&&(score+=1e3),b=arrAdj.length;b--;){for(c=arr.length,isMatch=!1;c--;)if(arr[c]==arrAdj[b]){score+=100,arr[c]="",isMatch=!0;break}if(!isMatch)for(c=arr.length;c--;)if("R"==arr[c]){score+=50,arr[c]="";break}}atpScore[n++]=printf("%4f",score)+":"+name}for(atpScore=atpScore.sort().reverse(),$("dragCon").innerHTML="",c=0;c<atpScore.length;c++)b=atpScore[c],b=b.replace(/.*:/g,""),$("dragCon").innerHTML+="<input type='radio' name='opls' id='"+b+"'><label for='"+b+"'>"+b+"<img src='./OPLS/"+b+".png' class='opls' ondblclick='getType(this.src)'></label><br>";$("dragCon").innerHTML+="<span id='atmIndex' lang=''></span><span id='atmType' lang=''></span>",$("atmIndex").lang=f,$("dragBox").style.display="block",$("dragCon").scrollTop=0}function getType(a){var b,c,d,f;if(a)a=a.replace(/.*(opls_.+).png/,"$1");else for(b=document.getElementsByName("opls"),c=b.length;c--;)b[c].checked&&(a=b[c].id);if($("atmType").lang=a,d=Mol(),d[0].numatoms-4*d[0].pbc,f=trim($("atmIndex").lang),f.length)for(f=f.split(/\s+/),c=f.length;c--;)d[f[c]].type=a;setATP(),$("dragBox").style.display="none"}function element(a,b){if(void 0===element.elem&&(element.elem=[],element.elem[0]=addElement(0,"X","s",0,0,0,0,0,0,0),element.elem[1]=addElement(1,"H","s",1,1.0079,31,255,255,255,2.2),element.elem[2]=addElement(2,"He","s",2,4.0026,28,217,255,255,0),element.elem[3]=addElement(3,"Li","s",1,6.941,128,204,128,255,.98),element.elem[4]=addElement(4,"Be","s",2,9.0122,96,194,255,0,1.57),element.elem[5]=addElement(5,"B","p",3,10.811,84,255,181,181,2.04),element.elem[6]=addElement(6,"C","p",4,12.0107,76,144,144,144,2.55),element.elem[7]=addElement(7,"N","p",5,14.0067,71,48,80,248,3.04),element.elem[8]=addElement(8,"O","p",6,15.9994,66,255,13,13,3.44),element.elem[9]=addElement(9,"F","p",7,18.9984,57,144,224,80,3.98),element.elem[10]=addElement(10,"Ne","p",8,20.1797,58,179,227,245,0),element.elem[11]=addElement(11,"Na","s",1,22.9897,166,171,92,242,.93),element.elem[12]=addElement(12,"Mg","s",2,24.305,141,138,255,0,1.31),element.elem[13]=addElement(13,"Al","p",3,26.9815,121,191,166,166,1.61),element.elem[14]=addElement(14,"Si","p",4,28.0855,111,240,200,160,1.9),element.elem[15]=addElement(15,"P","p",5,30.9738,107,255,128,0,2.19),element.elem[16]=addElement(16,"S","p",6,32.065,105,255,255,48,2.58),element.elem[17]=addElement(17,"Cl","p",7,35.453,102,31,240,31,3.16),element.elem[18]=addElement(18,"Ar","p",8,39.948,106,128,209,227,0),element.elem[19]=addElement(19,"K","s",1,39.0983,203,143,64,212,.82),element.elem[20]=addElement(20,"Ca","s",2,40.078,176,61,255,0,1),element.elem[21]=addElement(21,"Sc","d",3,44.9559,170,230,230,230,1.36),element.elem[22]=addElement(22,"Ti","d",4,47.867,160,191,194,199,1.54),element.elem[23]=addElement(23,"V","d",5,50.9415,153,166,166,171,1.63),element.elem[24]=addElement(24,"Cr","d",6,51.9961,139,138,153,199,1.66),element.elem[25]=addElement(25,"Mn","d",7,54.938,139,156,122,199,1.55),element.elem[26]=addElement(26,"Fe","d",8,55.845,132,224,102,51,1.83),element.elem[27]=addElement(27,"Co","d",9,58.9332,126,240,144,160,1.88),element.elem[28]=addElement(28,"Ni","d",10,58.6934,124,80,208,80,1.91),element.elem[29]=addElement(29,"Cu","d",11,63.546,132,200,128,51,1.9),element.elem[30]=addElement(30,"Zn","d",2,65.39,122,125,128,176,1.65),element.elem[31]=addElement(31,"Ga","p",3,69.723,122,194,143,143,1.81),element.elem[32]=addElement(32,"Ge","p",4,72.64,120,102,143,143,2.01),element.elem[33]=addElement(33,"As","p",5,74.9216,119,189,128,227,2.18),element.elem[34]=addElement(34,"Se","p",6,78.96,120,255,161,0,2.55),element.elem[35]=addElement(35,"Br","p",7,79.904,120,166,41,41,2.96),element.elem[36]=addElement(36,"Kr","p",8,83.8,116,92,184,209,3),element.elem[37]=addElement(37,"Rb","s",1,85.4678,220,112,46,176,.82),element.elem[38]=addElement(38,"Sr","s",2,87.62,195,0,255,0,.95),element.elem[39]=addElement(39,"Y","d",3,88.9059,190,148,255,255,1.22),element.elem[40]=addElement(40,"Zr","d",4,91.224,175,148,224,224,1.33),element.elem[41]=addElement(41,"Nb","d",5,92.9064,164,115,194,201,1.6),element.elem[42]=addElement(42,"Mo","d",6,95.94,154,84,181,181,2.16),element.elem[43]=addElement(43,"Tc","d",7,98,147,59,158,158,1.9),element.elem[44]=addElement(44,"Ru","d",8,101.07,146,36,143,143,2.2),element.elem[45]=addElement(45,"Rh","d",9,102.9055,142,10,125,140,2.28),element.elem[46]=addElement(46,"Pd","d",10,106.42,139,0,105,133,2.2),element.elem[47]=addElement(47,"Ag","d",11,107.8682,145,192,192,192,1.93),element.elem[48]=addElement(48,"Cd","d",2,112.411,144,255,217,143,1.69),element.elem[49]=addElement(49,"In","p",3,114.818,142,166,117,115,1.78),element.elem[50]=addElement(50,"Sn","p",4,118.71,139,102,128,128,1.96),element.elem[51]=addElement(51,"Sb","p",5,121.76,139,158,99,181,2.05),element.elem[52]=addElement(52,"Te","p",6,127.6,138,212,122,0,2.1),element.elem[53]=addElement(53,"I","p",7,126.9045,139,148,0,148,2.66),element.elem[54]=addElement(54,"Xe","p",8,131.293,140,66,158,176,2.6),element.elem[55]=addElement(55,"Cs","s",1,132.9055,244,87,23,143,.79),element.elem[56]=addElement(56,"Ba","s",2,137.327,215,0,201,0,.89),element.elem[57]=addElement(57,"La","d",3,138.9055,207,112,212,255,1.1),element.elem[58]=addElement(58,"Ce","f",4,140.116,204,255,255,199,1.12),element.elem[59]=addElement(59,"Pr","f",5,140.9077,203,217,255,199,1.13),element.elem[60]=addElement(60,"Nd","f",6,144.24,201,199,255,199,1.14),element.elem[61]=addElement(61,"Pm","f",7,145,199,163,255,199,0),element.elem[62]=addElement(62,"Sm","f",8,150.36,198,143,255,199,1.17),element.elem[63]=addElement(63,"Eu","f",9,151.964,198,97,255,199,0),element.elem[64]=addElement(64,"Gd","f",10,157.25,196,69,255,199,1.2),element.elem[65]=addElement(65,"Tb","f",11,158.9253,194,48,255,199,0),element.elem[66]=addElement(66,"Dy","f",12,162.5,192,31,255,199,1.22),element.elem[67]=addElement(67,"Ho","f",13,164.9303,192,0,255,156,1.23),element.elem[68]=addElement(68,"Er","f",14,167.259,189,0,230,117,1.24),element.elem[69]=addElement(69,"Tm","f",15,168.9342,190,0,212,82,1.25),element.elem[70]=addElement(70,"Yb","f",16,173.04,187,0,191,56,0),element.elem[71]=addElement(71,"Lu","f",17,174.967,187,0,171,36,1.27),element.elem[72]=addElement(72,"Hf","d",4,178.49,175,77,194,255,1.3),element.elem[73]=addElement(73,"Ta","d",5,180.9479,170,77,166,255,1.5),element.elem[74]=addElement(74,"W","d",6,183.84,162,33,148,214,2.36),element.elem[75]=addElement(75,"Re","d",7,186.207,151,38,125,171,1.9),element.elem[76]=addElement(76,"Os","d",8,190.23,144,38,102,150,2.2),element.elem[77]=addElement(77,"Ir","d",9,192.217,141,23,84,135,2.2),element.elem[78]=addElement(78,"Pt","d",10,195.078,136,208,208,224,2.28),element.elem[79]=addElement(79,"Au","d",11,196.9665,136,255,209,35,2.54),element.elem[80]=addElement(80,"Hg","d",2,200.59,132,184,184,208,2),element.elem[81]=addElement(81,"Tl","p",3,204.3833,145,166,84,77,1.62),element.elem[82]=addElement(82,"Pb","p",4,207.2,146,87,89,97,2.33),element.elem[83]=addElement(83,"Bi","p",5,208.9804,148,158,79,181,2.02),element.elem[84]=addElement(84,"Po","p",6,209,140,171,92,0,2),element.elem[85]=addElement(85,"At","p",7,210,150,117,79,69,2.2),element.elem[86]=addElement(86,"Rn","p",8,222,150,66,130,150,0),element.elem[87]=addElement(87,"Fr","s",1,223,260,66,0,102,.7),element.elem[88]=addElement(88,"Ra","s",2,226,221,0,125,0,.9),element.elem[89]=addElement(89,"Ac","d",3,227,215,112,171,250,1.1),element.elem[90]=addElement(90,"Th","f",4,232.0381,206,0,186,255,1.3),element.elem[91]=addElement(91,"Pa","f",5,231.0359,200,0,161,255,1.5),element.elem[92]=addElement(92,"U","f",6,238.0289,196,0,143,255,1.38),element.elem[93]=addElement(93,"Np","f",7,237,190,0,128,255,1.36),element.elem[94]=addElement(94,"Pu","f",8,244,187,0,107,255,1.28),element.elem[95]=addElement(95,"Am","f",9,243,180,84,92,242,1.3),element.elem[96]=addElement(96,"Cm","f",10,247,169,120,92,227,1.3),element.elem[97]=addElement(97,"Bk","f",11,247,168,138,79,227,1.3),element.elem[98]=addElement(98,"Cf","f",12,251,168,161,54,212,1.3),element.elem[99]=addElement(99,"Es","f",13,252,165,179,31,212,1.3),element.elem[100]=addElement(100,"Fm","f",14,257,167,179,31,186,1.3),element.elem[101]=addElement(101,"Md","f",15,258,173,179,13,166,1.3),element.elem[102]=addElement(102,"No","f",16,259,176,189,13,135,1.3),element.elem[103]=addElement(103,"Lr","f",17,262,161,199,0,102,0),element.elem[104]=addElement(104,"Rf","d",4,267,157,204,0,89,0),element.elem[105]=addElement(105,"Db","d",5,268,149,209,0,79,0),element.elem[106]=addElement(106,"Sg","d",6,269,143,217,0,69,0),element.elem[107]=addElement(107,"Bh","d",7,270,141,224,0,56,0),element.elem[108]=addElement(108,"Hs","d",8,269,134,230,0,46,0),element.elem[109]=addElement(109,"Mt","d",9,278,129,235,0,38,0),element.elem[110]=addElement(110,"Ds","d",10,281,0,0,0,28,0),element.elem[111]=addElement(111,"Rg","d",11,281,0,0,0,28,0),element.elem[112]=addElement(112,"Cn","d",12,285,0,0,0,28,0),element.elem[113]=addElement(113,"Uut","p",3,286,0,0,0,28,0),element.elem[114]=addElement(114,"Fl","p",4,289,0,0,0,28,0),element.elem[115]=addElement(115,"Uup","p",5,288,0,0,0,28,0),element.elem[116]=addElement(116,"Lv","p",6,293,0,0,0,28,0),element.elem[117]=addElement(117,"Uus","p",7,294,0,0,0,28,0),element.elem[118]=addElement(118,"Uuo","p",8,294,0,0,0,28,0)),0>a||a>element.elem.length)return alert("Element "+a+" is not defined."),0;switch(b){case"symbol":return element.elem[a].symbol;case"block":return element.elem[a].block;case"valence":return element.elem[a].valence;case"mass":return element.elem[a].mass;case"radius":return element.elem[a].radius;case"EN":return element.elem[a].EN;case"color":return element.elem[a].color;case"gradient":return element.elem[a].gradient;case"label":return element.elem[a].label;case"max":return element.elem.length;default:return alert("Param "+b+" is not defined."),0}}function elementObject(){this.symbol="?",this.block="?",this.valence=0,this.mass=0,this.radius=0,this.EN=0,this.color="rgb(88,88,88)",this.gradient="rgb(88,88,88)",this.label="rgb(255,255,255)"}function addElement(a,b,c,d,e,f,g,h,i,j){var k,l,m=new elementObject;return m.symbol=b,m.block=c,m.valence=d,m.mass=e,k=0>=f?.1:f/100,m.radius=k,m.color="rgb("+g+","+h+","+i+")",m.gradient="rgb("+Math.floor(g/2)+","+Math.floor(h/2)+","+Math.floor(i/2)+")",l=g+h+i,m.label=l>384?"rgb(0,0,0)":"rgb(255,255,255)",m.EN=j,m}function drawPeriodic(){var c,b="ptable",a="<table><tr>";a+='<td class="main" id="mH"  onclick="pickElem(\'H\');">H</td>',a+='<td class="Row"  id="Row1" colspan="12">&nbsp;</td>',a+='<td class="plabel" id="plabel" colspan="4" onclick="pickElem(\'PView\');">',a+='<div id="pchooser">Metals</div></td>',a+='<td class="metl" id="pHe" onclick="pickElem(\'He\');">He</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pLi" onclick="pickElem(\'Li\');">Li</td>',a+='<td class="metl" id="pBe" onclick="pickElem(\'Be\');">Be</td>',a+='<td class="Row"  id="Row2" colspan="10">&nbsp;</td>',a+='<td class="main" id="mB"  onclick="pickElem(\'B\');">B</td>',a+='<td class="main" id="mC"  onclick="pickElem(\'C\');">C</td>',a+='<td class="main" id="mN"  onclick="pickElem(\'N\');">N</td>',a+='<td class="main" id="mO"  onclick="pickElem(\'O\');">O</td>',a+='<td class="main" id="mF"  onclick="pickElem(\'F\');">F</td>',a+='<td class="metl" id="pNe" onclick="pickElem(\'Ne\');">Ne</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pNa" onclick="pickElem(\'Na\');">Na</td>',a+='<td class="metl" id="pMg" onclick="pickElem(\'Mg\');">Mg</td>',a+='<td class="Row"  id="Row3" colspan="10">&nbsp;</td>',a+='<td class="main" id="mAl" onclick="pickElem(\'Al\')">Al</td>',a+='<td class="main" id="mSi" onclick="pickElem(\'Si\')">Si</td>',a+='<td class="main" id="mP"  onclick="pickElem(\'P\')">P</td>',a+='<td class="main" id="mS"  onclick="pickElem(\'S\')">S</td>',a+='<td class="main" id="mCl" onclick="pickElem(\'Cl\')">Cl</td>',a+='<td class="metl" id="pAr" onclick="pickElem(\'Ar\')">Ar</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pK"  onclick="pickElem(\'K\')">K</td>',a+='<td class="metl" id="pCa" onclick="pickElem(\'Ca\')">Ca</td>',a+='<td class="metl" id="pSc" onclick="pickElem(\'Sc\')">Sc</td>',a+='<td class="metl" id="pTi" onclick="pickElem(\'Ti\')">Ti</td>',a+='<td class="metl" id="pV"  onclick="pickElem(\'V\')">V</td>',a+='<td class="metl" id="pCr" onclick="pickElem(\'Cr\')">Cr</td>',a+='<td class="metl" id="pMn" onclick="pickElem(\'Mn\')">Mn</td>',a+='<td class="metl" id="pFe" onclick="pickElem(\'Fe\')">Fe</td>',a+='<td class="metl" id="pCo" onclick="pickElem(\'Co\')">Co</td>',a+='<td class="metl" id="pNi" onclick="pickElem(\'Ni\')">Ni</td>',a+='<td class="metl" id="pCu" onclick="pickElem(\'Cu\')">Cu</td>',a+='<td class="metl" id="pZn" onclick="pickElem(\'Zn\')">Zn</td>',a+='<td class="main" id="mGa" onclick="pickElem(\'Ga\')">Ga</td>',a+='<td class="main" id="mGe" onclick="pickElem(\'Ge\')">Ge</td>',a+='<td class="main" id="mAs" onclick="pickElem(\'As\')">As</td>',a+='<td class="main" id="mSe" onclick="pickElem(\'Se\')">Se</td>',a+='<td class="main" id="mBr" onclick="pickElem(\'Br\')">Br</td>',a+='<td class="metl" id="pKr" onclick="pickElem(\'Kr\')">Kr</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pRb" onclick="pickElem(\'Rb\')">Rb</td>',a+='<td class="metl" id="pSr" onclick="pickElem(\'Sr\')">Sr</td>',a+='<td class="metl" id="pY"  onclick="pickElem(\'Y\')">Y</td>',a+='<td class="metl" id="pZr" onclick="pickElem(\'Zr\')">Zr</td>',a+='<td class="metl" id="pNb" onclick="pickElem(\'Nb\')">Nb</td>',a+='<td class="metl" id="pMo" onclick="pickElem(\'Mo\')">Mo</td>',a+='<td class="metl" id="pTc" onclick="pickElem(\'Tc\')">Tc</td>',a+='<td class="metl" id="pRu" onclick="pickElem(\'Ru\')">Ru</td>',a+='<td class="metl" id="pRh" onclick="pickElem(\'Rh\')">Rh</td>',a+='<td class="metl" id="pPd" onclick="pickElem(\'Pd\')">Pd</td>',a+='<td class="metl" id="pAg" onclick="pickElem(\'Ag\')">Ag</td>',a+='<td class="metl" id="pCd" onclick="pickElem(\'Cd\')">Cd</td>',a+='<td class="main" id="mIn" onclick="pickElem(\'In\')">In</td>',a+='<td class="main" id="mSn" onclick="pickElem(\'Sn\')">Sn</td>',a+='<td class="main" id="mSb" onclick="pickElem(\'Sb\')">Sb</td>',a+='<td class="main" id="mTe" onclick="pickElem(\'Te\')">Te</td>',a+='<td class="main" id="mI"  onclick="pickElem(\'I\')">I</td>',a+='<td class="metl" id="pXe" onclick="pickElem(\'Xe\')">Xe</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pCs" onclick="pickElem(\'Cs\')">Cs</td>',a+='<td class="metl" id="pBa" onclick="pickElem(\'Ba\')">Ba</td>',a+='<td class="metl" id="pLa" onclick="pickElem(\'La\')">La</td>',a+='<td class="metl" id="pHf" onclick="pickElem(\'Hf\')">Hf</td>',a+='<td class="metl" id="pTa" onclick="pickElem(\'Ta\')">Ta</td>',a+='<td class="metl" id="pW"  onclick="pickElem(\'W\')">W</td>',a+='<td class="metl" id="pRe" onclick="pickElem(\'Re\')">Re</td>',a+='<td class="metl" id="pOs" onclick="pickElem(\'Os\')">Os</td>',a+='<td class="metl" id="pIr" onclick="pickElem(\'Ir\')">Ir</td>',a+='<td class="metl" id="pPt" onclick="pickElem(\'Pt\')">Pt</td>',a+='<td class="metl" id="pAu" onclick="pickElem(\'Au\')">Au</td>',a+='<td class="metl" id="pHg" onclick="pickElem(\'Hg\')">Hg</td>',a+='<td class="main" id="mTl" onclick="pickElem(\'Tl\')">Tl</td>',a+='<td class="main" id="mPb" onclick="pickElem(\'Pb\')">Pb</td>',a+='<td class="main" id="mBi" onclick="pickElem(\'Bi\')">Bi</td>',a+='<td class="main" id="mPo" onclick="pickElem(\'Po\')">Po</td>',a+='<td class="main" id="mAt" onclick="pickElem(\'At\')">At</td>',a+='<td class="metl" id="pRn" onclick="pickElem(\'Rn\')">Rn</td>',a+="</tr>\n",a+="<tr>",a+='<td class="metl" id="pFr"  onclick="pickElem(\'Fr\')">Fr</td>',a+='<td class="metl" id="pRa"  onclick="pickElem(\'Ra\')">Ra</td>',a+='<td class="metl" id="pAc"  onclick="pickElem(\'Ac\')">Ac</td>',a+='<td class="metl" id="pRf"  onclick="pickElem(\'Rf\')">Rf</td>',a+='<td class="metl" id="pDb"  onclick="pickElem(\'Db\')">Db</td>',a+='<td class="metl" id="pSg"  onclick="pickElem(\'Sg\')">Sg</td>',a+='<td class="metl" id="pBh"  onclick="pickElem(\'Bh\')">Bh</td>',a+='<td class="metl" id="pHs"  onclick="pickElem(\'Hs\')">Hs</td>',a+='<td class="metl" id="pMt"  onclick="pickElem(\'Mt\')">Mt</td>',a+='<td class="metl" id="pDs"  onclick="pickElem(\'Ds\')">Ds</td>',a+='<td class="metl" id="pRg"  onclick="pickElem(\'Rg\')">Rg</td>',a+='<td class="metl" id="pCn"  onclick="pickElem(\'Cn\')">Cn</td>',a+='<td class="metl" id="pUut" onclick="pickElem(\'Uut\')">Uut</td>',a+='<td class="metl" id="pFl"  onclick="pickElem(\'Fl\')">Fl</td>',a+='<td class="metl" id="pUup" onclick="pickElem(\'Uup\')">Uup</td>',a+='<td class="metl" id="pLv"  onclick="pickElem(\'Lv\')">Lv</td>',a+='<td class="metl" id="pUus" onclick="pickElem(\'Uus\')">Uus</td>',a+='<td class="metl" id="pUuo" onclick="pickElem(\'Uuo\')">Uuo</td>',a+="</tr>\n",a+="<tr>",a+='<td class="Row"  id="RowLa" colspan="2">&nbsp;</td>',a+='<td class="metl" id="pCe" onclick="pickElem(\'Ce\')">Ce</td>',a+='<td class="metl" id="pPr" onclick="pickElem(\'Pr\')">Pr</td>',a+='<td class="metl" id="pNd" onclick="pickElem(\'Nd\')">Nd</td>',a+='<td class="metl" id="pPm" onclick="pickElem(\'Pm\')">Pm</td>',a+='<td class="metl" id="pSm" onclick="pickElem(\'Sm\')">Sm</td>',a+='<td class="metl" id="pEu" onclick="pickElem(\'Eu\')">Eu</td>',a+='<td class="metl" id="pGd" onclick="pickElem(\'Gd\')">Gd</td>',a+='<td class="metl" id="pTb" onclick="pickElem(\'Tb\')">Tb</td>',a+='<td class="metl" id="pDy" onclick="pickElem(\'Dy\')">Dy</td>',a+='<td class="metl" id="pHo" onclick="pickElem(\'Ho\')">Ho</td>',a+='<td class="metl" id="pEr" onclick="pickElem(\'Er\')">Er</td>',a+='<td class="metl" id="pTm" onclick="pickElem(\'Tm\')">Tm</td>',a+='<td class="metl" id="pYb" onclick="pickElem(\'Yb\')">Yb</td>',a+='<td class="metl" id="pLu" onclick="pickElem(\'Lu\')">Lu</td>',a+='<td class="Row"  id="RowLa2" colspan="2">&nbsp;</td>',a+="</tr>\n",a+="<tr>",a+='<td class="Row"  id="RowAc" colspan="2">&nbsp;</td>',a+='<td class="metl" id="pTh" onclick="pickElem(\'Th\')">Th</td>',a+='<td class="metl" id="pPa" onclick="pickElem(\'Pa\')">Pa</td>',a+='<td class="metl" id="pU"  onclick="pickElem(\'U\')" >U</td>',a+='<td class="metl" id="pNp" onclick="pickElem(\'Np\')">Np</td>',a+='<td class="metl" id="pPu" onclick="pickElem(\'Pu\')">Pu</td>',a+='<td class="metl" id="pAm" onclick="pickElem(\'Am\')">Am</td>',a+='<td class="metl" id="pCm" onclick="pickElem(\'Cm\')">Cm</td>',a+='<td class="metl" id="pBk" onclick="pickElem(\'Bk\')">Bk</td>',a+='<td class="metl" id="pCf" onclick="pickElem(\'Cf\')">Cf</td>',a+='<td class="metl" id="pEs" onclick="pickElem(\'Es\')">Es</td>',a+='<td class="metl" id="pFm" onclick="pickElem(\'Fm\')">Fm</td>',a+='<td class="metl" id="pMd" onclick="pickElem(\'Md\')">Md</td>',a+='<td class="metl" id="pNo" onclick="pickElem(\'No\')">No</td>',a+='<td class="metl" id="pLr" onclick="pickElem(\'Lr\')">Lr</td>',a+='<td class="Row"  id="RowAc2" colspan="2">&nbsp;</td>',a+="</tr></table>\n",c=$(b),c&&(c.innerHTML=a)
}function Mol(a){var b,c=a||0;return void 0===Mol.molecule&&(Mol.molecule=1),c>0&&(Mol.molecule=c,BondMatrix(c)),b=Mol.molecule,void 0===Mol.moly&&(Mol.moly=[]),void 0===Mol.moly[b]&&(Mol.moly[b]=[],Mol.moly[b][0]=new molObject,Mol.moly[b][0].molindex=b,Mol.moly[b][0].numatoms=0,Mol.moly[b][0].pbc=0,Mol.moly[b][0].atomscale=1,Mol.moly[b][0].showlabels=0,Mol.moly[b][0].showcharges=0,Mol.moly[b][0].gradients=1,Mol.moly[b][0].highlite=0,Mol.moly[b][0].formula="",Mol.moly[b][0].weight=0,Mol.moly[b][0].charge=999,Mol.moly[b][0].box=[[0,0,0],[0,0,0],[0,0,0]],Mol.moly[b][0].invBox=[[0,0,0],[0,0,0],[0,0,0]]),Mol.moly[b]}function BondMatrix(a){var b,c=a||0;return void 0===BondMatrix.id&&(BondMatrix.id=1),c>0&&(BondMatrix.id=c),b=BondMatrix.id,void 0===BondMatrix.bonds&&(BondMatrix.bonds=[]),void 0===BondMatrix.bonds[b]&&(BondMatrix.bonds[b]=[]),BondMatrix.bonds[b]}function activeWin(a){var b,c,e,f,d=a||" ";if(void 0===activeWin.mol&&(activeWin.mol=[],activeWin.mol[0]="Dummy"),void 0===activeWin.win){if(e=document.getElementsByTagName("canvas"),!e[0])return;activeWin.win=e[0].id,activeWin.mol[1]=activeWin.win}for(d.length>1&&(activeWin.win=d),c=-1,b=0;b<activeWin.mol.length;b++)activeWin.mol[b]==activeWin.win&&(c=b);return 0>c&&(c=activeWin.mol.length,activeWin.mol[c]=activeWin.win),Mol(c),f=$(activeWin.win),f&&(f.onmousedown=MouseDown,document.onmouseup=MouseUp,f.onmousemove=MouseMove,f.addEventListener("mousewheel",MouseWheel,!1),f.addEventListener("DOMMouseScroll",MouseWheel,!1),f.addEventListener("touchstart",MouseDown),f.addEventListener("touchend",MouseUp),f.addEventListener("touchmove",MouseMove)),activeWin.win}function atomObject(){this.atomicnumber=0,this.x=0,this.u=0,this.xi=0,this.y=0,this.v=0,this.yi=0,this.z=0,this.w=0,this.zi=0,this.charge=0,this.highlite=0,this.type=""}function molObject(){this.molindex=1,this.numatoms=0,this.pbc=0,this.hide=0,this.highlite=0,this.gradients=1,this.showlabels=1,this.showcharges=0,this.formula="",this.atomscale=1,this.weight=0,this.charge=999,this.box=[[0,0,0],[0,0,0],[0,0,0]],this.invBox=[[0,0,0],[0,0,0],[0,0,0]]}function readPDBfile(a){var b,c,d,e,f,g,h,i,j,m,o,p,k=[],l=Mol();for(delMolecule(),InfoWin("",1),e=0,b=0;b<a.length;b++)if(j=trim(a[b].substr(0,6)),k=a[b].split(/\s+/),d=k.length,"ATOM"==j||"HETATM"==j){if(e++,f=lookupSymbol(k[d-2]),1>f||f>118)return InfoWin("*** ERROR Reading PDB file. ***\n"),void 0;g=parseFloat(a[b].substr(31,8)),h=parseFloat(a[b].substr(39,8)),i=parseFloat(a[b].substr(47,8)),addAtom(f,g,h,i),InfoWin(" "+k[0]+"("+f+")  "+g+", "+h+", "+i+"\n")}else if("CONECT"==j)for(c=2;d-1>c;c++)addBond(k[1],k[c]);else"REMARK"==j&&a[b].search(/box\s*=/)>-1&&(j=trim(a[b].replace(/.+box\s*=\s*[\(\<\[]+/,"").replace(/[\)\>\]]+.*/,"")).split(/\s+/),c=j.length,1==c&&(m=parseFloat(j[0]),o=m,p=m),3==c&&(m=parseFloat(j[0]),o=parseFloat(j[1]),p=parseFloat(j[2])),l[0].pbc=1,l[0].box=[[m,0,0],[0,o,0],[0,0,p]],l[0].invBox=invMat([[m,0,0],[0,o,0],[0,0,p]]));for(l[0].pbc&&(e++,addAtom(0,0,0,0),l[e].hide=1,e++,addAtom(0,m,0,0),l[e].hide=1,e++,addAtom(0,0,o,0),l[e].hide=1,e++,addAtom(0,0,0,p),l[e].hide=1),n=l[0].numatoms,b=1;e>b;b++)for(x1=l[b].x,y1=l[b].y,z1=l[b].z,c=b+1;e>=c;c++)x2=l[c].x,y2=l[c].y,z2=l[c].z,l[0].pbc&&(du=Math.round(l[c].u-l[b].u),dv=Math.round(l[c].v-l[b].v),dw=Math.round(l[c].w-l[b].w),dx=l[n-3].x,dy=l[n-3].y,dz=l[n-3].z,x2-=dot([du,dv,dw],[l[n-2].x-dx,l[n-1].x-dx,l[n].x-dx]),y2-=dot([du,dv,dw],[l[n-2].y-dy,l[n-1].y-dy,l[n].y-dy]),z2-=dot([du,dv,dw],[l[n-2].z-dz,l[n-1].z-dz,l[n].z-dz])),bond=1.2*(element(l[b].atomicnumber,"radius")+element(l[c].atomicnumber,"radius")),dx=x2-x1,dy=y2-y1,dz=z2-z1,r=Math.sqrt(dx*dx+dy*dy+dz*dz),bond>=r&&addBond(b,c);formula(),setATP(),InfoWin("Finished reading PDB input file.\n")}function readXYZfile(a){var b,c,d,e,f,g,h,i,j,k,l,m,p=[],q=[],r=Mol();if(delMolecule(),InfoWin("",1),d=parseInt(a[0].replace(/\s+/,"")),isNaN(d))return InfoWin("*** ERROR Reading XYZ file. ***\n"),void 0;for(q=a[1],q=q.replace(/\s+$/,""),InfoWin(q+"\n"),InfoWin("Looking for "+d+" atoms.\n"),a[1].search(/box\s*=/)>-1&&(txt=trim(a[1].replace(/.+box\s*=\s*[\(\<\[]+/,"").replace(/[\)\>\]]+.*/,"")).split(/\s+/),c=txt.length,1==c&&(boxA=parseFloat(txt[0]),boxB=boxA,boxC=boxA),3==c&&(boxA=parseFloat(txt[0]),boxB=parseFloat(txt[1]),boxC=parseFloat(txt[2])),r[0].pbc=1,r[0].box=[[boxA,0,0],[0,boxB,0],[0,0,boxC]],r[0].invBox=invMat([[boxA,0,0],[0,boxB,0],[0,0,boxC]])),b=2;d+2>b;b++){if(p=a[b].replace(/\s+/g," ").replace(/^\s+/,"").split(" "),e=lookupSymbol(p[0]),1>e||e>118)return InfoWin("*** ERROR Reading XYZ file. ***\n"),void 0;f=parseFloat(p[1]),g=parseFloat(p[2]),h=parseFloat(p[3]),addAtom(e,f,g,h),InfoWin(" "+p[0]+"("+e+")  "+f+", "+g+", "+h+"\n")}for(r[0].pbc&&(d++,addAtom(0,0,0,0),r[d].hide=1,d++,addAtom(0,boxA,0,0),r[d].hide=1,d++,addAtom(0,0,boxB,0),r[d].hide=1,d++,addAtom(0,0,0,boxC),r[d].hide=1),n=r[0].numatoms,b=1;d>b;b++)for(x1=r[b].x,y1=r[b].y,z1=r[b].z,c=b+1;d>=c;c++)x2=r[c].x,y2=r[c].y,z2=r[c].z,r[0].pbc&&(du=Math.round(r[c].u-r[b].u),dv=Math.round(r[c].v-r[b].v),dw=Math.round(r[c].w-r[b].w),i=r[n-3].x,j=r[n-3].y,k=r[n-3].z,x2-=dot([du,dv,dw],[r[n-2].x-i,r[n-1].x-i,r[n].x-i]),y2-=dot([du,dv,dw],[r[n-2].y-j,r[n-1].y-j,r[n].y-j]),z2-=dot([du,dv,dw],[r[n-2].z-k,r[n-1].z-k,r[n].z-k])),m=1.2*(element(r[b].atomicnumber,"radius")+element(r[c].atomicnumber,"radius")),i=x2-x1,j=y2-y1,k=z2-z1,l=Math.sqrt(i*i+j*j+k*k),m>=l&&addBond(b,c);formula(),setATP(),InfoWin("Finished reading XYZ input file.\n")}function readMOLfile(a,b){var c,d,e,f,g,h,i,j,k,n,o,p;for(Mol(),n=escape(a.name),InfoWin("File Name = "+n,1),InfoWin("\nFile Type = "+a.type),InfoWin("\nFile Size = "+a.size),delMolecule(),c=0;b[c].toUpperCase().indexOf("<TRIPOS>MOLECULE")<=0;)c++;for(c++,name=trim(b[c]),c++,txt=trim(b[c]).split(/\s+/),o=parseFloat(txt[0]),p=parseFloat(txt[1]),InfoWin(name+" "+o+" atoms and "+p+" bonds.");b[c].toUpperCase().indexOf("<TRIPOS>ATOM")<=0;)c++;for(c++,d=o+c;d>c;c++)txt=trim(b[c]).split(/\s+/),e=parseFloat(txt[2]),f=parseFloat(txt[3]),g=parseFloat(txt[4]),k=txt[5].replace(/\s+/,""),j=lookupSymbol(k),addAtom(j,e,f,g),InfoWin("\n   "+k+"("+j+")  "+e+", "+f+", "+g);for(;b[c].toUpperCase().indexOf("<TRIPOS>BOND")<=0;)c++;for(c++,d=p+c;d>c;c++)txt=trim(b[c]).split(/\s+/),h=parseFloat(txt[1]),i=parseFloat(txt[2]),addBond(h,i),InfoWin("\n   Bond from "+h+" to "+i);formula(),setATP()}function readMOL2file(a,b){var c,d,e,f,g,h,i,j,k,n,o,p,l=[];for(Mol(),n=escape(a.name),InfoWin("File Name = "+n,1),InfoWin("\nFile Type = "+a.type),InfoWin("\nFile Size = "+a.size),delMolecule(),l=b[0],l=l.replace(/\s+$/,""),o=parseFloat(b[3].substr(0,3)),p=parseFloat(b[3].substr(3,3)),InfoWin("\n\n"+l),InfoWin("\n"+o+" atoms and "+p+" bonds."),d=o+4,c=4;d>c;c++)e=parseFloat(b[c].substr(0,10)),f=parseFloat(b[c].substr(10,10)),g=parseFloat(b[c].substr(20,10)),k=b[c].substr(31,3),k=k.replace(/\s+/,""),j=lookupSymbol(k),InfoWin("\n   "+k+"("+j+")  "+e+", "+f+", "+g),addAtom(j,e,f,g);for(d=4+o+p,c=4+o;d>c;c++)h=parseFloat(b[c].substr(0,3)),i=parseFloat(b[c].substr(3,3)),InfoWin("\n   Bond from "+h+" to "+i),addBond(h,i);formula(),setATP()}function readINPfile(a){var b,c,d,e,f,i,l=[],m=Mol();for(InfoWin("--- Reading Gamess input file ---\n",1),delMolecule(),b=0,a[b].toLowerCase();a[b].toLowerCase().indexOf("$data")<0;)b++;for(b++,l=a[b],l=l.replace(/\s+$/,""),InfoWin("\n\nTitle: ["+l+"]\n"),b++,a[b].toLowerCase().indexOf("c1")<0&&b++,b++;a[b].toLowerCase().indexOf("$end")<0;)InfoWin("   Line = ["+a[b]+"]\n"),current=a[b].replace(/\s+/g," ").replace(/^\s+/,"").split(" "),i=parseInt(current[1]),d=parseFloat(current[2]),e=parseFloat(current[3]),f=parseFloat(current[4]),addAtom(i,d,e,f),b++;for(b=1;b<m[0].numatoms;b++)for(ra=element(m[b].atomicnumber,"radius"),c=b+1;c<=m[0].numatoms;c++)rb=element(m[b].atomicnumber,"radius"),r=.9*distance(m,b,c),ra+rb>=r&&addBond(b,c);InfoWin("Finished reading input file.\n"),formula()}function lookupSymbol(a){var b;for(b=1;b<element(1,"max");b++)if(element(b,"symbol")==a)return b;return 0}function delMolecule(){var a=Mol();a[0]=new molObject,a[0].molindex=1,a[0].numatoms=0,a[0].pbc=0,a[0].atomscale=1,a[0].showlabels=0,a[0].showcharges=0,a[0].box=[[0,0,0],[0,0,0],[0,0,0]],a[0].invBox=[[0,0,0],[0,0,0],[0,0,0]],buttonColor("ChargeButton",0)}function Undo(a){var b,c,e=10,f=Mol(),g=BondMatrix();if(void 0===Undo.num)for(Undo.num=0,Undo.mol=[],Undo.bonds=[],b=0;e>b;b++)Undo.mol[b]=[],Undo.mol[b][0]=0,Undo.bonds[b]=[];if("save"==a){for(c=Undo.num,Undo.mol[c]=null,Undo.mol[c]=[],Undo.mol[c][0]=f[0].numatoms,b=1;b<=f[0].numatoms;b++)Undo.mol[c][b]=new atomObject,Undo.mol[c][b].atomicnumber=f[b].atomicnumber,Undo.mol[c][b].x=f[b].x,Undo.mol[c][b].y=f[b].y,Undo.mol[c][b].z=f[b].z,Undo.mol[c][b].bonds=[],Undo.mol[c][b].charge=f[b].charge,Undo.mol[c][b].highlite=f[b].highlite;for(Undo.bonds[c]=null,Undo.bonds[c]=[],b=1;b<=f[0].numatoms;b++)for(Undo.bonds[c][b]=[],j=0;j<=f[0].numatoms;j++)Undo.bonds[c][b][j]=g[b][j];return Undo.num=(Undo.num+1)%e,void 0}if("pop"==a&&(Undo("save"),c=(Undo.num+e-2)%e,Undo.num=c,Undo.mol[c][0]<1))return alert("ERROR: No saved coordinates to restore."),void 0;if("redo"==a&&(c=(Undo.num+1)%e,Undo.num=c,Undo.mol[c][0]<1))return alert("ERROR: No saved coordinates to restore."),void 0;if("redo"==a||"pop"==a){for(f[0].numatoms=Undo.mol[c][0],b=1;b<=Undo.mol[c][0];b++)f[b].atomicnumber=Undo.mol[c][b].atomicnumber,f[b].x=Undo.mol[c][b].x,f[b].y=Undo.mol[c][b].y,f[b].z=Undo.mol[c][b].z,f[b].charge=Undo.mol[c][b].charge,f[b].highlite=Undo.mol[c][b].highlite;for(b=1;b<=f[0].numatoms;b++)for(j=0;j<=f[0].numatoms;j++)g[b][j]=Undo.bonds[c][b][j];return centerMolecule(),drawMolecule(),void 0}}function invMat(a){var b=[[0,0,0],[0,0,0],[0,0,0]],c=a[0][0]*(a[1][1]*a[2][2]-a[1][2]*a[2][1])-a[0][1]*(a[1][0]*a[2][2]-a[1][2]*a[2][0])+a[0][2]*(a[1][0]*a[2][1]-a[1][1]*a[2][0]);return 0!=c&&(c=1/c),b[0][0]=(a[1][1]*a[2][2]-a[1][2]*a[2][1])*c,b[1][0]=-(a[1][0]*a[2][2]-a[1][2]*a[2][0])*c,b[2][0]=(a[1][0]*a[2][1]-a[1][1]*a[2][0])*c,b[0][1]=-(a[0][1]*a[2][2]-a[0][2]*a[2][1])*c,b[1][1]=(a[0][0]*a[2][2]-a[0][2]*a[2][0])*c,b[2][1]=-(a[0][0]*a[2][1]-a[0][1]*a[2][0])*c,b[0][2]=(a[0][1]*a[1][2]-a[0][2]*a[1][1])*c,b[1][2]=-(a[0][0]*a[1][2]-a[0][2]*a[1][0])*c,b[2][2]=(a[0][0]*a[1][1]-a[0][1]*a[1][0])*c,b}function dot(a,b){for(var c=0,d=a.length;d--;)c+=a[d]*b[d];return c}function addAtom(a,b,c,d){var e,f,g=Mol(),h=BondMatrix();for(g[0].numatoms++,f=g[0].numatoms,g[0].showcharges=0,buttonColor("ChargeButton",0),g[f]=new atomObject,g[f].atomicnumber=a,g[f].x=b,g[f].xi=b,g[f].u=dot(g[0].invBox[0],[b,c,d]),g[f].y=c,g[f].yi=c,g[f].v=dot(g[0].invBox[1],[b,c,d]),g[f].z=d,g[f].zi=d,g[f].w=dot(g[0].invBox[2],[b,c,d]),g[f].charge=0,g[f].highlite=0,void 0===h[f]&&(h[f]=[]),h[f][0]=0,e=1;f>=e;e++)h[e][f]=0,h[f][e]=0}function addBond(a,b){var h,f=Mol();f[0].numatoms,h=BondMatrix(),h[a][0]++,h[a][b]=1,h[b][0]++,h[b][a]=1}function delAtom(a){var b,c,h,i,e=0,n=[],o=Mol(),p=BondMatrix();for(o[0].showcharges=0,buttonColor("ChargeButton",0),i=a,b=1;a>b;b++)p[a][b]>0&&1==o[b].atomicnumber&&(n[e++]=b,i--);for(b=a+1;b<=o[0].numatoms;b++)p[a][b]>0&&1==o[b].atomicnumber&&(n[e++]=b);for(n.sort(function(a,b){return b-a}),b=0;e>b;b++)delAtom(n[b]);for(a=i,b=a;b<o[0].numatoms;b++)c=b+1,o[b].atomicnumber=o[c].atomicnumber,o[b].x=o[c].x,o[b].y=o[c].y,o[b].z=o[c].z,o[b].charge=o[c].charge,o[b].highlite=o[c].highlite;for(o[0].numatoms--,h=o[0].numatoms,b=1;a>b;b++){for(p[b][a]>0&&p[b][0]--,c=a;h>=c;c++)p[b][c]=p[b][c+1];p[b][h+1]=0}for(b=a;h>=b;b++){for(p[b+1][a]>0&&p[b+1][0]--,c=0;a>c;c++)p[b][c]=p[b+1][c];for(c=a;h>=c;c++)p[b][c]=p[b+1][c+1];p[b][h+1]=0}for(b=0;h+1>=b;b++)p[h+1][b]=0;drawMolecule()}function delBond(a,b){var e=BondMatrix();e[a][b]>0&&(e[a][b]=0,e[a][0]--),e[b][a]>0&&(e[b][a]=0,e[b][0]--)}function hideH(){var a,b=Mol();for(a=1;a<=b[0].numatoms;a++)1==b[a].atomicnumber&&(b[a].hide=1);drawMolecule()}function showAll(){var a,b=Mol();for(a=1;a<b[0].numatoms;a++)b[a].hide=0}function centerMolecule(){var a,b,h,d=0,i=activeWin(""),j=Mol(),k=$(i),l=k.height,e=0,f=0,g=0,c=j[0].numatoms;for(a=1;c>=a;a++)e+=j[a].x,f+=j[a].y,g+=j[a].z;for(e/=c,f/=c,g/=c,d=0,a=1;c>=a;a++)b=j[a].atomicnumber,j[a].x-=e,j[a].y-=f,j[a].z-=g,h=Math.abs(j[a].x),h=Math.max(h,Math.abs(j[a].y)),h=Math.max(h,Math.abs(j[a].z)),h+=element(b,"radius"),d=Math.max(d,h);j[0].atomscale=.5*l/d}function showGlobal(){var a,b=Mol();for(InfoWin("numatoms = "+b[0].numatoms,1),InfoWin("\nAtomScale = "+b[0].atomscale.toFixed(6)),InfoWin("\n"),a=1;a<=b[0].numatoms;a++)A=b[a].atomicnumber,InfoWin(a+"  "+element(A,"symbol")),InfoWin(" ("+b[a].x.toFixed(4)),InfoWin(", "+b[a].y.toFixed(4)),InfoWin(", "+b[a].z.toFixed(4)),InfoWin(")\n")}function showCoord(a){{var b,f,d=Mol();BondMatrix()}if(!(d[0].weight<=0)){for(a=0,a&&(InfoWin("Molecular Coordinates and Bond Information\n",1),InfoWin("   "+d[0].formula+"  ("+d[0].weight.toFixed(2)+" g/mol)"),999!=d[0].charge&&0!=d[0].charge&&InfoWin("   Charge = "+d[0].charge),InfoWin("\n")),f="",b=1;b<=d[0].numatoms;b++)f+="<tr><td>"+element(d[b].atomicnumber,"symbol")+"</td><td>"+XYZpretty(d[b].x)+"</td><td>"+XYZpretty(d[b].y)+"</td><td>"+XYZpretty(d[b].z)+"</td><td>"+d[b].type+"</td></tr>";InfoWin(f,1)}}function XYZpretty(a){var b="    ",c=[];return c=a>=100?b+" "+a.toFixed(4):a>=10?b+"  "+a.toFixed(4):a>=0?b+"   "+a.toFixed(4):a>=-10?b+"  "+a.toFixed(4):a>=-100?b+" "+a.toFixed(4):b+a.toFixed(4)}function formula(){var a,b,c,d,e,f,g=[],h="Formula: ",i=Mol();if(!(i[0].numatoms<1)){for(e=0,a=1;a<=i[0].numatoms;a++)6==i[a].atomicnumber&&(g[e]=[],g[e][0]=6,g[e][1]=0,e++,a=i[0].numatoms+1);for(a=1;a<=i[0].numatoms;a++)1==i[a].atomicnumber&&(g[e]=[],g[e][0]=1,g[e][1]=0,e++,a=i[0].numatoms+1);for(a=1;a<=i[0].numatoms;a++){for(c=i[a].atomicnumber,d=0,b=0;e>b;b++)g[b][0]==c&&(g[b][1]++,d=1,b=e);0==d&&(g[e]=Array(2),g[e][0]=i[a].atomicnumber,g[e][1]=1,e++)}for(f=0,i[0].formula="",a=0;e>a;a++)c=g[a][0],f+=element(c,"mass")*g[a][1],h+=element(c,"symbol"),i[0].formula+=element(c,"symbol"),g[a][1]>1&&(h+="<sub>"+g[a][1]+"</sub>",i[0].formula+=g[a][1]+" ");h+="  Weight: "+f,i[0].weight=f,$("formula")&&($("formula").innerHTML=h),f>0&&InfoWin(i[0].formula+" has a molecular weight of "+f.toFixed(2)+"\n")}}function RotateMolecule(a){var b=20;if(a=a[0].toLowerCase(),"x"==a||"y"==a||"z"==a||"s"==a)switch(void 0===RotateMolecule.RX&&(RotateMolecule.RX=0,RotateMolecule.RY=0,RotateMolecule.RZ=0),a){case"x":0==RotateMolecule.RX?(RotateMolecule.RX=1,RotateX_ID=setInterval("rotateX()",b),buttonColor("rotateX",1)):(RotateMolecule.RX=0,clearInterval(RotateX_ID),buttonColor("rotateX",0));break;case"y":0==RotateMolecule.RY?(RotateMolecule.RY=1,RotateY_ID=setInterval("rotateY()",b),buttonColor("rotateY",1)):(RotateMolecule.RY=0,clearInterval(RotateY_ID),buttonColor("rotateY",0));break;case"z":0==RotateMolecule.RZ?(RotateMolecule.RZ=1,RotateZ_ID=setInterval("rotateZ()",b),buttonColor("rotateZ",1)):(RotateMolecule.RZ=0,clearInterval(RotateZ_ID),buttonColor("rotateZ",0));break;case"s":0!=RotateMolecule.RX&&(RotateMolecule.RX=0,clearInterval(RotateX_ID)),0!=RotateMolecule.RY&&(RotateMolecule.RY=0,clearInterval(RotateY_ID)),0!=RotateMolecule.RZ&&(RotateMolecule.RZ=0,clearInterval(RotateZ_ID)),buttonColor("rotateX",0),buttonColor("rotateY",0),buttonColor("rotateZ",0)}}function rotateX(){var a,c,d,e=1,f=Math.cos(-e*Math.PI/180),g=Math.sin(-e*Math.PI/180),h=Mol();for(a=1;a<=h[0].numatoms;a++)c=h[a].y,d=h[a].z,h[a].y=f*c+g*d,h[a].z=-g*c+f*d;drawMolecule()}function rotateY(){var a,b,d,e=1,f=Math.cos(-e*Math.PI/180),g=Math.sin(-e*Math.PI/180),h=Mol();for(a=1;a<=h[0].numatoms;a++)b=h[a].x,d=h[a].z,h[a].x=f*b+g*d,h[a].z=-g*b+f*d;drawMolecule()}function rotateZ(){var a,b,c,e=1,f=Math.cos(-e*Math.PI/180),g=Math.sin(-e*Math.PI/180),h=Mol();for(a=1;a<=h[0].numatoms;a++)b=h[a].x,c=h[a].y,h[a].x=f*b+g*c,h[a].y=-g*b+f*c;drawMolecule()}function drawMolecule(){var a,b,c,u,v,w,x,y,g=BondMatrix(),h=Mol(),j=h[0].numatoms,q=.5,r=2,s=activeWin(""),t=$(s);if(t){if(u=t.getContext("2d"),v=t.width,w=t.height,x=t.width/2,y=t.height/2,clear(u,v,w),u.strokeStyle="rgb(0, 0, 255)",u.lineWidth=3,void 0===drawMolecule.deep&&(drawMolecule.deep=[]),drawMolecule.deep.length!=j)for(b=0,drawMolecule.deep=[],a=drawMolecule.deep.length;j>a;a++)b++,drawMolecule.deep[a]=[],drawMolecule.deep[a]["id"]=b,drawMolecule.deep[a]["sz"]=h[b].z;for(a=0;j>a;a++)b=drawMolecule.deep[a].id,drawMolecule.deep[a].z=h[b].z;for(drawMolecule.deep.sort(function(a,b){return b.z-a.z}),j>r&&(h[0].gradients=0),a=0;j>a;a++)if(atom=drawMolecule.deep[a].id,!h[atom].hide)for(h[0].gradients?drawAtom(u,atom,q,x,y):drawAtomPlain(u,atom,q,x,y),0!=h[0].showcharges&&DrawChargeCloud(u,atom,1.5*q,x,y),0!=h[atom].highlite&&DrawAtomHilite(u,atom,1.5*q,x,y),b=1;j>=b;b++)if(g[atom][b]>0&&b!=atom&&!h[b].hide)for(c=a+1;j>c;c++)drawMolecule.deep[c].id==b&&(drawBond(u,atom,b,q,x,y,h[0].gradients),(Math.abs(h[atom].u-h[b].u)>.5||Math.abs(h[atom].v-h[b].v)>.5||Math.abs(h[atom].w-h[b].w)>.5)&&drawBond(u,b,atom,q,x,y,h[0].gradients))}}function showLabels(){var a=Mol();return 0==a[0].showlabels?(buttonColor("LabelButton",1),a[0].showlabels=1,drawMolecule(),void 0):(buttonColor("LabelButton",0),a[0].showlabels=0,drawMolecule(),void 0)}function drawAtom(a,b,c,d,e){var f,g,h,i,j,k,l,m=Mol();activeWin(""),f=m[b].atomicnumber,g=m[0].atomscale*m[b].x+d,h=m[0].atomscale*m[b].y+e,i=m[0].atomscale*c*element(f,"radius"),j=g-.2*i,k=h-.2*i,l=.3*i,g=Math.floor(g+.5),h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),AtomColor=a.createRadialGradient(j,k,l,g,h,i),AtomColor.addColorStop(0,element(f,"color")),AtomColor.addColorStop(1,element(f,"gradient")),a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath(),0!=m[0].showlabels&&atomLabel(a,f,b,g,h)}function drawAtomPlain(a,b,c,d,e){var f,g,h,i,j,k,l,m=Mol();activeWin(""),f=m[b].atomicnumber,g=m[0].atomscale*m[b].x+d,h=m[0].atomscale*m[b].y+e,i=m[0].atomscale*c*element(f,"radius"),j=g-.2*i,k=h-.2*i,l=.3*i,g=Math.floor(g+.5),h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=element(f,"color"),a.fill(),a.lineWidth=1,a.strokeStyle="black",a.stroke(),a.closePath(),0!=m[0].showlabels&&atomLabel(a,f,b,g,h)}function DrawChargeCloud(a,b,c,d,e){var f,g,h,i,j,k,l,m,p,n=Mol();activeWin(""),f=n[b].atomicnumber,g=n[0].atomscale*n[b].x+d,h=n[0].atomscale*n[b].y+e,i=n[0].atomscale*c*element(f,"radius"),p=n[b].charge,p>=0&&(m=p>1?1:p,j=0,l=0,k=255),0>p&&(m=-1>p?1:-p,j=255,l=0,k=0),AtomColor="rgba("+j+","+l+","+k+","+m+")",a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath()}function DrawAtomHilite(a,b,c,d,e){var f,g,h,i,n=Mol();activeWin(""),f=n[b].atomicnumber,g=n[0].atomscale*n[b].x+d,h=n[0].atomscale*n[b].y+e,i=n[0].atomscale*c*element(f,"radius"),AtomColor="rgba(255,255,0,0.5)",a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath()}function atomLabel(a,b,c,d,e){var k,f=element(b,"symbol")+c,g=14,h=parseFloat(d),i=parseFloat(e)+g/2,j=Mol();a.lineWidth=1,a.textAlign="center",a.font="normal "+g+"px sans-serif",a.fillStyle=element(b,"label"),a.beginPath(),a.fillText(f,h,i),k=10/j[0].atomscale,a.fillRect(h,i,1.5*k,k),a.closePath()}function drawBond(a,b,c,d,e,f,g){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,D,E,F,B=Mol();activeWin(""),D=B[0].atomscale,E=Math.floor(.1*D+.5),F="rgb(200,128,51)",r=Math.round(B[c].u-B[b].u),s=Math.round(B[c].v-B[b].v),t=Math.round(B[c].w-B[b].w),k=B[0].numatoms,A=D*d*element(B[b].atomicnumber,"radius")-2,l=D*B[b].x+e,m=D*B[b].y+f,n=D*B[b].z,u=B[k-3].x,v=B[k-3].y,w=B[k-3].z,o=D*(B[c].x-dot([r,s,t],[B[k-2].x-u,B[k-1].x-u,B[k].x-u]))+e,p=D*(B[c].y-dot([r,s,t],[B[k-2].y-v,B[k-1].y-v,B[k].y-v]))+f,q=D*(B[c].z-dot([r,s,t],[B[k-2].z-w,B[k-1].z-w,B[k].z-w])),g||(a.beginPath(),a.moveTo(x,y),a.lineTo(o,p),a.lineWidth=E,a.strokeStyle=F,a.stroke(),a.closePath()),u=o-l,v=p-m,w=q-n,z=Math.sqrt(u*u+v*v+w*w),x=l+A*u/z,y=m+A*v/z,a.beginPath(),a.moveTo(x,y),a.lineTo(o,p),a.lineWidth=E+2,a.strokeStyle="rgb(0,0,0)",a.stroke(),a.moveTo(x,y),a.lineTo(o,p),a.lineWidth=E,a.strokeStyle=F,a.stroke(),a.closePath()}function clear(a,b,c){a.fillStyle="rgb(255,255,255)",a.fillRect(0,0,b,c),a.beginPath(),a.rect(1,1,b-1,c-1),a.lineWidth=2,a.strokeStyle="rgb(95,95,127)",a.stroke(),a.closePath()}function drawHighlight(a,b,c,d,e){var f,g,h,n,s=Mol(),t=BondMatrix(),u=$(a),v=u.getContext("2d"),w=u.width,x=u.height;if(clear(v,w,x),v.strokeStyle="rgb(0, 0, 255)",v.lineWidth=3,void 0===drawHighlight.deep&&(drawHighlight.deep=[]),drawHighlight.deep.length!=s[0].numatoms)for(g=0,drawHighlight.deep=[],f=drawHighlight.deep.length;f<s[0].numatoms;f++)g++,drawHighlight.deep[f]=[],drawHighlight.deep[f]["id"]=g,drawHighlight.deep[f]["sz"]=s[g].z;for(f=0;f<s[0].numatoms;f++)g=drawHighlight.deep[f].id,drawHighlight.deep[f].z=s[g].z;for(drawHighlight.deep.sort(function(a,b){return b.z-a.z}),f=0;f<s[0].numatoms;f++){for(atom=drawHighlight.deep[f].id,hilite=0,ih=1;ih<=3*b[0];ih++)atom==b[ih]&&(hilite=1);for(HighlightAtom(v,atom,hilite,c,d,e),n=1;n<=s[0].numatoms;n++)if(t[atom][n]>0){if(highbond=0,hilite>0)for(ih=1;ih<3*b[0];ih++)n==b[ih]&&(highbond=1);for(h=f+1;h<s[0].numatoms;h++)drawHighlight.deep[h].id==n&&HighlightBond(v,atom,n,highbond,c,d,e)}}}function HighlightAtom(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q=[],s="rgb(255,  0,  0)",t="rgb(127,  0,  0)",u=Mol();activeWin(""),g=u[b].atomicnumber,h=u[0].atomscale*u[b].x+e,i=u[0].atomscale*u[b].y+f,j=u[0].atomscale*d*element(g,"radius"),k=h-.2*j,l=i-.2*j,m=.3*j,h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),l=Math.floor(l+.5),AtomColor=a.createRadialGradient(k,l,m,h,i,j),alpha=.33,c>0&&(alpha=1),n=element(g,"color").indexOf("(")+1,o=element(g,"color").indexOf(")")-n,p=element(g,"color").substr(n,o),q=p.replace(/,/g," ").split(" "),s="rgba("+q[0]+","+q[1]+","+q[2]+","+alpha+")",n=element(g,"gradient").indexOf("(")+1,o=element(g,"gradient").indexOf(")")-n,p=element(g,"gradient").substr(n,o),q=p.replace(/,/g," ").split(" "),t="rgba("+q[0]+","+q[1]+","+q[2]+","+alpha+")",AtomColor.addColorStop(0,s),AtomColor.addColorStop(1,t),a.beginPath(),a.arc(h,i,j,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath(),c>0&&atomLabel(a,g,b,h,i)}function HighlightBond(a,b,c,d,e,f,g){var k,l,m,n,o,p,q,r,s,t,u,v,w,x=B[0].atomscale,y=Math.floor(.1*x+.5),z="rgba(200,128,51,1.0)",A="rgba(191,191,191,0.33)",B=Mol();activeWin(""),w=x*e*element(B[b].atomicnumber,"radius"),k=x*B[b].x+f,l=x*B[b].y+g,m=x*B[b].z,n=x*B[c].x+f,o=x*B[c].y+g,p=x*B[c].z,q=n-k,r=o-l,s=p-m,v=Math.sqrt(q*q+r*r+s*s),t=k+w*q/v,u=l+w*r/v,a.beginPath(),a.moveTo(t,u),a.lineTo(n,o),a.lineWidth=y+2,a.strokeStyle="rgba(0,0,0,0.33)",d>0&&(a.strokeStyle="rgba(0,0,0,1.0)"),a.stroke(),a.moveTo(t,u),a.lineTo(n,o),a.lineWidth=y,a.strokeStyle=d>0?z:A,a.stroke(),a.closePath()}function mouseState(a,b){return void 0===mouseState.DownAtom&&(mouseState.DownAtom=-1),"Show"==a?mouseState.DownAtom:("Set"==a&&(mouseState.DownAtom=b),void 0)}function parameters(){return void 0===parameters.values&&(parameters.values=new paramObject),void 0===parameters.values.mode&&(parameters.values.mode="View"),void 0===parameters.values.elem&&(parameters.values.elem="C"),void 0===parameters.values.clouds&&(parameters.values.clouds=4),void 0===parameters.values.add&&(parameters.values.add="Add"),void 0===parameters.values.bond&&(parameters.values.bond="Add"),parameters.values}function paramObject(){this.mode="View",this.element="C",this.clouds=4,this.bondmode="Add",this.atommode="Add"}function MouseDown(a){var d=a.target.id,e=activeWin(d),f=$(e),g=f.width,h=f.height,b=a.pageX,c=a.pageY;a.targetTouches&&1==a.targetTouches.length&&(b=a.targetTouches[0].pageX,c=a.targetTouches[0].pageY),mouseState("Set",onAtom(b,c,f,g,h))}function MouseUp(a){var d,f=activeWin(""),g=Mol(),h=$(f),i=h.width,j=h.height,k=parameters(),b=a.pageX,c=a.pageY;return a.targetTouches&&(b=a.targetTouches[0].pageX,c=a.targetTouches[0].pageY),d=mouseState("Show"),mouseState("Set",-1),Upatom=onAtom(b,c,h,i,j),0==Upatom?(viewGeom(0),void 0):(Upatom==d&&("View"==k.mode&&(a.shiftKey>0?(g[Upatom].highlite=(g[Upatom].highlite+1)%2,drawMolecule()):viewGeom(d)),"Draw"==k.mode&&(Undo("save"),g[0].charge=999,"Delete"==k.atommode?delAtom(Upatom):newAtom(Upatom))),Upatom!=d&&"Draw"==k.mode&&(Undo("save"),"Add"==k.bondmode&&(g[0].charge=999,addBond(d,Upatom)),"Delete"==k.bondmode&&(g[0].charge=999,delBond(d,Upatom)),"Rotate"==k.bondmode&&BondRotation("Set",d,Upatom),drawMolecule()),void 0)}function onAtom(a,b,c,d,e){var f,g,h,i,j,k,l=.5,m=Mol();for(a=a-c.offsetLeft-d/2,b=b-c.offsetTop-e/2,f=1;f<=m[0].numatoms;f++)if(g=m[f].atomicnumber,j=m[0].atomscale*l*element(g,"radius"),j*=j,h=m[0].atomscale*m[f].x-a,i=m[0].atomscale*m[f].y-b,k=h*h+i*i,j>=k)return f;return 0}function MouseWheel(a){var c,d,b=Mol();return a.preventDefault&&a.preventDefault(),c=a.detail?-1*a.detail:a.wheelDelta,d=c>0?1.1:.9,b[0].atomscale=b[0].atomscale*d,drawMolecule(),!1}function MouseMove(a){var b,c,d,e,f,g,h,j,k,l,o,p,q,r,s,t,w=2,x=Mol(),y=parameters();if(void 0===MouseMove.cx&&(MouseMove.cx=250),void 0===MouseMove.cy&&(MouseMove.cy=250),0==mouseState("Show")){if(b=a.pageX,c=a.pageY,a.targetTouches&&1==a.targetTouches.length&&(b=a.targetTouches[0].pageX,c=a.targetTouches[0].pageY),d=MouseMove.cx-b,e=MouseMove.cy-c,MouseMove.cx=b,MouseMove.cy=c,Math.abs(d)+Math.abs(e)>10)return;if("Rotate"==y.bondmode)return h=d+e,BondRotation("Rotate",h),drawMolecule(),void 0;if(a.shiftKey>0){for(q=Math.cos(d*w*Math.PI/180),t=Math.sin(d*w*Math.PI/180),i=1;i<=x[0].numatoms;i++)j=x[i].x,k=x[i].y,x[i].x=q*j+t*k,x[i].y=-t*j+q*k;return drawMolecule(),void 0}if(a.ctrlKey>0){for(f=.01*d,g=.01*e,i=1;i<=x[0].numatoms;i++)j=x[i].x,k=x[i].y,x[i].x=j-f,x[i].y=k-g;return drawMolecule(),void 0}for(o=Math.cos(e*w*Math.PI/180),r=Math.sin(e*w*Math.PI/180),p=Math.cos(d*w*Math.PI/180),s=Math.sin(d*w*Math.PI/180),i=1;i<=x[0].numatoms;i++)j=x[i].x,k=x[i].y,l=x[i].z,x[i].x=p*j+s*l,x[i].y=-r*s*j+o*k+r*p*l,x[i].z=-o*s*j-r*k+o*p*l;drawMolecule()}}function viewGeom(a){var b,c,d,e,f,g,h,i,j,s,y,t=activeWin(""),u=$(t),v=u.getContext("2d"),w=u.width;if(u.height,y=Mol(),void 0===viewGeom.geom&&(viewGeom.geom=[0,0,0,0,0]),0==a){for(b=0;5>b;b++)viewGeom.geom[b]=0;return drawMolecule(),void 0}if(a)for(b=1;5>b;b++)viewGeom.geom[b]==a&&viewGeom(0);switch(viewGeom.geom[0]=viewGeom.geom[0]+1,sw=viewGeom.geom[0],viewGeom.geom[sw]=a,InfoWin("Mouse on atom #"+a+"   Switch = "+sw,1),sw){case 1:for(b=y[0].numatoms;b--;)y[b].highlite=0;y[viewGeom.geom[1]].highlite=1,drawMolecule(),showType(viewGeom.geom[1]);break;case 20:g=y[viewGeom.geom[1]].x-y[viewGeom.geom[2]].x,h=y[viewGeom.geom[1]].y-y[viewGeom.geom[2]].y,i=y[viewGeom.geom[1]].z-y[viewGeom.geom[2]].z,j=Math.sqrt(g*g+h*h+i*i),j=j.toFixed(3),j=""+j,c=y[viewGeom.geom[1]].atomicnumber,d=y[viewGeom.geom[2]].atomicnumber,s=element(c,"symbol")+(""+viewGeom.geom[1])+"--",s+=element(d,"symbol")+(""+viewGeom.geom[2]),s+=" = "+j,drawMolecule(),geomLabel(v,s,w);break;case 30:c=y[viewGeom.geom[1]].atomicnumber,d=y[viewGeom.geom[2]].atomicnumber,e=y[viewGeom.geom[3]].atomicnumber,s=element(c,"symbol")+(""+viewGeom.geom[1])+"--",s+=element(d,"symbol")+(""+viewGeom.geom[2])+"--",s+=element(e,"symbol")+(""+viewGeom.geom[3]),ang=angle(y,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3]),ang=ang.toFixed(1),ang=""+ang,s+=" = "+ang+"ᵒ",drawMolecule(),geomLabel(v,s,w);break;case 40:for(c=y[viewGeom.geom[1]].atomicnumber,d=y[viewGeom.geom[2]].atomicnumber,e=y[viewGeom.geom[3]].atomicnumber,f=y[viewGeom.geom[4]].atomicnumber,s=element(c,"symbol")+(""+viewGeom.geom[1])+"--",s+=element(d,"symbol")+(""+viewGeom.geom[2])+"--",s+=element(e,"symbol")+(""+viewGeom.geom[3])+"--",s+=element(f,"symbol")+(""+viewGeom.geom[4]),ang=dihedral(y,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3],viewGeom.geom[4]),ang=ang.toFixed(1),ang=""+ang,s+=" = "+ang,drawMolecule(),geomLabel(v,s,w),b=0;5>b;b++)viewGeom.geom[b]=0}}function geomLabel(a,b,c){a.lineWidth=1,a.textAlign="right",a.textBaseline="top",a.font="normal 18px sans-serif",a.fillStyle="#000000",a.beginPath(),a.fillText(b,c-5,5),a.closePath()}function pickElem(a){var c,d,e,b=element(1,"max"),g=parameters(),h="silver",i="lightskyblue";for(void 0===pickElem.metals&&(pickElem.metals="none",pickElem.myfont="14px",$("pchooser")&&($("pchooser").innerHTML="Metals")),"PView"==a&&$("pchooser")&&("Metals"==$("pchooser").innerHTML?(pickElem.metals="table-cell",pickElem.myfont="10px",$("pchooser").innerHTML="Organic"):(pickElem.metals="none",pickElem.myfont="14px",$("pchooser").innerHTML="Metals")),$("Row1")&&($("Row1").style.display=pickElem.metals),$("Row2")&&($("Row2").style.display=pickElem.metals),$("Row3")&&($("Row3").style.display=pickElem.metals),$("RowLa")&&($("RowLa").style.display=pickElem.metals),$("RowAc")&&($("RowAc").style.display=pickElem.metals),$("RowLa2")&&($("RowLa2").style.display=pickElem.metals),$("RowAc2")&&($("RowAc2").style.display=pickElem.metals),c=1;b>c;c++)delete e,d="m"+element(c,"symbol"),$(d)&&(e=$(d).style),d="p"+element(c,"symbol"),$(d)&&(e=$(d).style,e.display=pickElem.metals),e&&(e.backgroundColor=h,e.fontSize=pickElem.myfont,element(c,"symbol")==a&&(e.backgroundColor=i));return buttonColor("delbtn",0),buttonColor("delbond",0),buttonColor("rotbond",0),"Delete"==a?(buttonColor("delbtn",1),g.atommode="Delete",void 0):"DelBond"==a?(buttonColor("delbond",1),g.bondmode="Delete",void 0):"RotateBond"==a?("Rotate"!=g.bondmode?(buttonColor("rotbond",1),g.bondmode="Rotate"):(g.bondmode="",BondRotation("Clear")),void 0):(g.element=a,g.atommode="Add",g.bondmode="Add",void 0)}function pickClouds(a){var b,c,d=parseInt(a),e=parameters();for(b=1;5>b;b++)c="cld"+b,buttonColor(c,0),b==d&&buttonColor(c,1);e.clouds=d}function drawmode(){var a=parameters();$("drawDiv")&&($("drawDiv").style.display="inline"),$("viewDiv")&&($("viewDiv").style.display="none"),buttonColor("modeDraw",1),buttonColor("modeView",0),a.mode="Draw",a.element="C",a.atommode="Add",a.bondmode="Add"}function viewmode(){var a=parameters();$("drawDiv")&&($("drawDiv").style.display="none"),$("viewDiv")&&($("viewDiv").style.display="inline"),buttonColor("modeDraw",0),buttonColor("modeView",1),a.mode="View",pickElem("ClearBond"),formula(),showCoord(1)}function BondRotation(a,b,c){var d,e,f,g,h,i,k,l,m=1,n=Mol();if(void 0===BondRotation.RotateAtom1&&(BondRotation.RotateAtom1=0),void 0===BondRotation.RotateAtom2&&(BondRotation.RotateAtom2=0),void 0===BondRotation.RotateList&&(BondRotation.RotateList=[],BondRotation.RotateList[0]=0),"Clear"==a)return BondRotation.RotateAtom1=0,BondRotation.RotateAtom2=0,BondRotation.RotateList[0]=0,void 0;if("Set"==a)return BondRotation.RotateAtom1=b,BondRotation.RotateAtom2=c,bondAlign(b,c),void 0;if("Rotate"==a){for(atom1=BondRotation.RotateAtom1,atom2=BondRotation.RotateAtom2,k=Math.cos(b*m*Math.PI/360),l=Math.sin(b*m*Math.PI/360),0==BondRotation.RotateList[0]&&(BondRotation.RotateList[0]=1,BondRotation.RotateList[1]=BondRotation.RotateAtom2,BondRotation.RotateList=rotlist(BondRotation.RotateList,atom1,atom2)),InfoWin("\n--- Bond rotation ---\n"),d=1;d<=BondRotation.RotateList[0];d++)j=BondRotation.RotateList[d],InfoWin(element(n[j].atomicnumber,"symbol")+j+"\n");for(h=n[atom1].x,i=n[atom1].y,e=1;e<=BondRotation.RotateList[0];e++)d=BondRotation.RotateList[e],f=n[d].x-h,g=n[d].y-i,n[d].x=k*f+l*g+h,n[d].y=-l*f+k*g+i}}function bondAlign(a,b){var c,d,e,f,j,k,l,m,n=Mol(),g=n[b].x-n[a].x,h=n[b].y-n[a].y,i=n[b].z-n[a].z;for(0==h&&0==i?(j=1,l=0):(j=Math.sqrt(i*i/(h*h+i*i)),l=Math.sqrt(1-j*j)),vsign=h*i,0>vsign&&(l=-l),f=l*h+j*i,0==g&&0==f?(k=1,m=0):(k=Math.sqrt(f*f/(g*g+f*f)),m=Math.sqrt(1-k*k)),vsign=g*f,0>vsign&&(m=-m),c=1;c<=n[0].numatoms;c++)d=n[c].x,e=n[c].y,f=n[c].z,n[c].x=d*k-e*l*m-f*j*m,n[c].y=e*j-f*l,n[c].z=d*m+e*l*k+f*j*k;if(n[a].z<n[b].z)for(c=1;c<=n[0].numatoms;c++)n[c].x=-n[c].x,n[c].z=-n[c].z}function rotlist(a,b,c){var e,f,g,h=Mol(),i=BondMatrix();
for(f=1;f<=h[0].numatoms;f++)if(i[c][f]>0){for(g=0,f==b&&(g=1),e=1;e<=a[0];e++)f==a[e]&&(g=1,e=a[0]+1);0==g&&(a[0]++,a[a[0]]=f,rotlist(a,c,f))}return a}function setCharge(){var a=Mol(),b=$("SelectCharge");b&&(a[0].charge=1*b.value)}function simpleQ(){var a,b,c=[],d=$("bondMatrix"),e=Mol(),f=e[0].numatoms;if(1>f)return InfoWin("Cannot set charges. No atoms found.\n",1),void 0;if(0!=e[0].showcharges)return buttonColor("ChargeButton",0),e[0].showcharges=0,$("SelectCharge")&&($("SelectCharge").value=0),drawMolecule(),void 0;for(buttonColor("ChargeButton",1),e[0].showcharges=1,InfoWin("",1),d&&(d.innerHTML=""),a=0;f>=a;a++)for(c[a]=[],b=0;f>=b;b++)c[a][b]=0;for(a=1;f>=a;a++)e[a].charge=0;sigmaBonds(c),999==e[0].charge&&formalcharge(),checkcharge(c),checkOctet(c),limitShare(c),formPi(c),checkOctet(c),formDative(c),atomicCharge(c),d&&showBondMatrix(c,d),drawMolecule()}function formalcharge(){var a,c,d,g=Mol(),h=g[0].numatoms,i=BondMatrix(),e=0,f=0;for(a=1;h>=a;a++)c=0,"s"==element(g[a].atomicnumber,"block")&&(c=2),"p"==element(g[a].atomicnumber,"block")&&(c=8),c>0&&(d=i[a][0]+element(g[a].atomicnumber,"valence")-c,0>d&&(f+=d),d>0&&(e+=d));for(;-2>=f;)f+=2;g[0].charge=e+f}function checkcharge(a){var b,c,d,e,f,g,j,k,l,n,h=Mol(),i=h[0].numatoms;for(BondMatrix(),n=1e-5,e=0,b=1;i>=b;b++)for(e+=element(h[b].atomicnumber,"valence"),c=b;i>=c;c++)e-=a[b][c];if(f=e-h[0].charge,!(Math.abs(f)<n)){if(-n>f){for(k=0,b=1;b<=h[0].numatoms;b++)j=element(h[b].atomicnumber,"block"),("d"==j||"f"==j)&&k++;if(k>0)for(g=-f/k,b=1;b<=h[0].numatoms;b++)j=element(h[b].atomicnumber,"block"),("d"==j||"f"==j)&&(a[b][b]-=g);else{for(d=0,b=1;b<=h[0].numatoms;b++)a[b][b]>0&&d++;if(l=-f,d>0)for(l=0,g=-f/d,b=1;b<=h[0].numatoms;b++)a[b][b]>0&&(a[b][b]-=g,a[b][b]<0&&(l-=a[b][b],a[b][b]=0));if(l>0){for(d=0,b=1;b<=h[0].numatoms;b++)a[b][b]>0&&d++;if(d>0)for(g=l/d,b=1;b<=h[0].numatoms;b++)a[b][b]>0&&(a[b][b]-=g)}}}if(f>n){for(checkOctet(a),d=0,b=1;b<=h[0].numatoms;b++)a[b][0]>0&&d++;if(l=f,d>0){for(l=0,g=f/d,b=1;b<=h[0].numatoms;b++)a[b][0]>0&&(g<=a[b][0]?a[b][b]+=g:(a[b][b]+=a[b][0],l+=g-a[b][0],a[b][0]=0));if(l>0){for(d=0,b=1;b<=h[0].numatoms;b++)a[b][0]>0&&d++;if(d>0)for(g=l/d,l=0,b=1;b<=h[0].numatoms;b++)a[b][0]>0&&(g<=a[b][0]?a[b][b]+=g:(a[b][b]+=a[b][0],l+=g-a[b][0],a[b][0]=0))}}if(l>0){for(d=0,b=1;b<=h[0].numatoms;b++)h[b].atomicnumber>12&&d++;if(d>0)for(g=l/d,b=1;b<=h[0].numatoms;b++)h[b].atomicnumber>12&&(a[b][b]+=g)}}for(e=0,b=1;i>=b;b++)for(e+=element(h[b].atomicnumber,"valence"),c=b;i>=c;c++)e-=a[b][c];f=e-h[0].charge,Math.abs(f)>n&&(InfoWin("ERROR: Unable to assign electrons to balance charge.\n",1),InfoWin("   Assigned charge = "+h[0].charge+"\n"),InfoWin("Charge based on e- = "+e+"\n\n"))}}function sigmaBonds(a){var b,c,d,e=Mol(),f=e[0].numatoms,g=BondMatrix();for(b=1;f>b;b++)for(c=b+1;f>=c;c++)g[b][c]>0&&(a[b][c]=2,a[c][b]=2);for(b=1;f>=b;b++)d=element(e[b].atomicnumber,"valence")-g[b][0],e[b].atomicnumber<11&&g[b][0]>3&&(d=0),d>0&&(a[b][b]=d);return a}function checkOctet(a){var b,c,d,e=Mol(),f=e[0].numatoms;for(b=1;f>=b;b++){if(d=0,a[b][0]=0,"p"==element(e[b].atomicnumber,"block"))for(d=8,c=1;f>=c;c++)d-=a[b][c];d>0&&(a[b][0]=d)}return a}function limitShare(a){var b,c,d,e=Mol(),f=e[0].numatoms,g=BondMatrix();for(b=1;f>=b;b++)if(a[b][0]>0){for(d=0,c=1;f>=c;c++)g[b][c]>0&&a[c][0]>0&&d++;a[b][0]=d>0?a[b][0]/d:0}return a}function formPi(a){var b,c,e,f=Mol(),g=f[0].numatoms,h=BondMatrix();for(b=1;g>b;b++)if(a[b][0]>0)for(c=b+1;g>=c;c++)h[b][c]>0&&(e=Math.min(a[b][0],a[c][0]),e>0&&(a[b][c]+=2*e,a[c][b]+=2*e,a[b][b]-=e,a[c][c]-=e));for(b=1;g>=b;b++)a[b][b]<0&&(InfoWin("ERROR in formPi: Atom "+b+" has "+a[b][b].toFixed(3)+" lone pairs.\n"),a[b][b]=0);return a}function formDative(a){var b,c,e,g,h=[],i=Mol(),j=i[0].numatoms,k=BondMatrix(),f=0;for(b=1;j>=b;b++)a[b][0]>0&&(f=1);if(0!=f){for(b=1;j>=b;b++)h[b]=0;for(b=1;j>=b;b++)if(a[b][0]>0){for(e=0,c=1;j>=c;c++)k[b][c]>0&&a[c][c]>0&&e++;if(e>0)for(a[b][0]=a[b][0]/e,c=1;j>=c;c++)k[b][c]>0&&a[c][c]>0&&(h[c]+=a[b][0])}for(g=1,b=1;j>=b;b++)h[b]>a[b][b]&&(g=0);if(g>0)for(b=1;j>=b;b++)if(a[b][0]>0)for(c=1;j>=c;c++)k[b][c]>0&&h[c]>0&&(a[b][c]+=a[b][0],a[c][b]+=a[b][0],a[c][c]-=a[b][0]);return a}}function atomicCharge(a){var f,g,h,i,j,k,l,m,b=.5,c=.5,d=15,e=.001,n=0,o=[],p=Mol(),q=p[0].numatoms,r=BondMatrix();for(f=1;q>=f;f++)for(n+=element(p[f].atomicnumber,"valence"),g=1;q>=g;g++)n-=f==g?a[f][f]:.5*a[f][g];for(l=Math.abs(n-p[0].charge),l>.001&&alert("Error: Electron assignment does NOT match molecular charge."),j=c,Math.abs(n)>.001&&(j=1),f=1;q>=f;f++)i=p[f].atomicnumber,("d"==element(i,"block")||"f"==element(i,"block"))&&(j=0),k=element(i,"EN")||0,0==k&&(k=1,InfoWin("WARNING: No electronegativity defined for "),InfoWin(element(p[f].atomicnumber,"symbol")+"\n")),o[f]=k;for(1==j&&InfoWin("Using 100% formal charge method to calculate charges.\n"),0==j&&InfoWin("Using 100% bond polarity method to calculate charges.\n"),j==c&&InfoWin("Using mixture of formal charge and bond polarity method to calculate charges.\n"),h=0,m=100;d>h&&m>e;){for(h++,f=1;q>=f;f++){for(i=p[f].atomicnumber,k=j*(element(i,"valence")-a[f][f]),g=1;q>=g;g++)r[f][g]>0&&(k+=.5*(1-j)*a[f][g],k-=a[f][g]*o[f]/(o[f]+o[g]));p[f].charge=k}for(m=0,f=1;q>=f;f++)k=o[f],o[f]=element(p[f].atomicnumber,"EN")||1,o[f]+=b*p[f].charge,l=Math.abs(k-o[f]),l>m&&(m=l)}return a}function dipoleMoment(){var a,e,f=4.8032,g=Mol(),h=g[0].numatoms,b=0,c=0,d=0;for(a=1;h>=a;a++)b+=g[a].x*g[a].charge,c+=g[a].y*g[a].charge,d+=g[a].z*g[a].charge;return e=f*Math.sqrt(b*b+c*c+d*d)}function showBondMatrix(a,b){var c,d,h,j,k,n,o;for(n=Mol(),o=n[0].numatoms,k=0,c=1;o>=c;c++)k+=n[c].charge;for(h=dipoleMoment(),b.innerHTML="<p><strong>Molecular charge = "+k.toFixed(1)+", Dipole &approx; "+h.toFixed(1)+" D</strong>",InfoWin("Bond Matrix:  Off-diagonal = e- in bonds, diagonal = unshared e-\n"),InfoWin("      "),c=1;o>=c;c++)j=element(n[c].atomicnumber,"symbol"),j.length<2&&(j+=" "),InfoWin(" "+j+" "),0==c%5&&InfoWin(" ");for(InfoWin("\n"),c=1;o>=c;c++){for(j=element(n[c].atomicnumber,"symbol"),j.length<2&&(j+=" "),10>c&&InfoWin(" "),InfoWin(c+" "+j+" "),d=1;o>=d;d++)InfoWin(a[c][d].toFixed(1)+" "),0==d%5&&InfoWin(" ");InfoWin(" q = "),n[c].charge>0&&InfoWin("+"),InfoWin(n[c].charge.toFixed(2)+"\n"),0==c%5&&InfoWin("\n")}}function MyFileReader(a){var b,d,c=a.target.files[0];c?(d=new FileReader,d.onload=function(a){var d,e,f;return b=0,d=extension(c.name),e=a.target.result,f=e.split("\n"),"pdb"==d&&(b=1,readPDBfile(f)),"xyz"==d&&(b=1,readXYZfile(f)),"mol2"==d&&(b=1,readMOLfile(c,f)),"inp"==d&&(b=1,readINPfile(c,f)),"str"==d&&(b=1,readSTRfile(c,f)),0==b?(InfoWin("*** ERROR: Invalid file type for "+c.name+". ***",1),void 0):(centerMolecule(),drawMolecule(),void 0)},d.readAsText(c)):alert("Failed to load file")}function extension(a){var b=a.substring(a.lastIndexOf(".")+1);return b.toLowerCase()}function showgallery(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;if("delete"==a)return void 0!==showgallery.num&&(showgallery.num=0,delete showgallery.list),void 0;if(!$("gallery"))return alert('Warning: showgallery called, but no <div id="gallery"></div> exists on html page.'),void 0;for(void 0===showgallery.list&&(showgallery.num=0,showgallery.list=[]),g=showgallery.num,k="gallerycanvas",j="galleryframe",h=g,f=0;f<c.length;f++)showgallery.list[h]=b+c[f],showgallery.num++,h++;for(n='width="'+e+'" height="'+e+'"></canvas>',i="",a&&(i="<h3>"+a+"</h3>\n"),h=g,f=0;f<c.length;f++)m=k+h,l=j+h,i+='<div class="galleryframe" id="'+l+'">',i+='<canvas id="'+m+'" '+n+"\n",i+='<p style="text-align: center;">',i+=d[f],i+="</p></div>\n",h++;for(i+='<p class="clear">&nbsp;</p>\n\n',$("gallery").innerHTML+=i,$("debug")&&($("debug").innerHTML+=i),px=e+"px",h=g,f=0;f<c.length;f++)l=j+h,$(l)&&($(l).style.width=px),h++;for(f=0;f<showgallery.num;f++)m=k+f,activeWin(m),delMolecule(),readServerFile(showgallery.list[f]),$("debug")&&(i="\n\nProcessed molecule "+f,i+=" named "+showgallery.list[f],$("debug").innerHTML+=i)}function galleryUniform(){for(var a,c,e="gallerycanvas",f=[],b=0,d=e+b;$(d);)b++,d=e+b;for(c=1e3,a=0;b>a;a++)d=e+a,activeWin(d),f=Mol(),f[0].atomscale<c&&(c=f[0].atomscale);if(1e3>c)for(a=0;b>a;a++)d=e+a,activeWin(d),f=Mol(),f[0].atomscale=c,drawMolecule()}function galleryReset(){for(var a,d="gallerycanvas",b=0,c=d+b;$(c);)b++,c=d+b;for(a=0;b>a;a++)c=d+a,activeWin(c),centerMolecule(),drawMolecule()}function readServerFile(a){var b,c,e,f;return e=extension(a),f=new XMLHttpRequest,f.open("GET",a,!1),f.send(),b=f.responseText.split("\n"),c=0,"xyz"==e&&(c=1,readXYZfile(b)),"mol2"==e&&(c=1,readMOLfile(localfile,b)),"inp"==e&&(c=1,readINPfile(localfile,b)),0==c?(InfoWin("*** ERROR: Invalid file type. ***",1),void 0):(centerMolecule(),drawMolecule(),void 0)}function InfoWin(a,b){var c=a||"",d=b||0;d>0?$("information").innerHTML=c:$("information").innerHTML+=c}function loadMolecule(){addAtom(6,-2.245,.945,-.011),addAtom(1,-1.888,-.063,-.011),addAtom(1,-1.888,1.45,-.885),addAtom(1,-3.315,.946,-.012),addAtom(7,-1.755,1.638,1.189),addAtom(8,-1.548,2.858,1.158),addAtom(8,-1.549,1.002,2.23),addBond(1,2),addBond(1,3),addBond(1,4),addBond(1,5),addBond(5,6),addBond(5,7),setATP()}function resetView(){var a,b=Mol();for(a=1;a<=b[0].numatoms-4*b[0].pbc;a++)b[a].highlite=0,b[a].hide=0;InfoWin("",1),formula(),centerMolecule(),drawMolecule()}function buttonColor(a,b){b=b||0;var c="silver";b&&(c="lightskyblue"),$(a)&&($(a).style.backgroundColor=c)}function initialize(){var d,a=activeWin(),b=$("molfile"),c=$("typfile");return a?(b&&c&&(window.File&&window.FileReader&&window.FileList&&window.Blob?(b.addEventListener("change",MyFileReader,!1),c.addEventListener("change",MyFileReader,!1)):alert("The File APIs are not fully supported by your browser.")),drawPeriodic(),d=Mol(),viewmode(),void 0===d&&delMolecule(),d[0].numatoms<1&&(delMolecule(),loadMolecule(),formula(),centerMolecule()),drawMolecule(),pickClouds(4),pickElem("C"),void 0):(userDefined(),a=activeWin(""),a||alert("No canvas present. Either create a canvas or remove onLoad=initialize() statement from <body>."),void 0)}function newAtom(a){var b,c,e,f,g,h,i,j,k,m,n,o=[],p=parameters(),q=Mol(),r=BondMatrix(),s=activeWin("");if(atomicNumber=lookupSymbol(p.element),e=r[a][0],0==e)return k=element(atomicNumber,"radius")+element(q[a].atomicnumber,"radius"),dx=q[a].x+k,dy=q[a].y,dz=q[a].z,addAtom(atomicNumber,dx,dy,dz),addBond(a,q[0].numatoms),addH(q[0].numatoms),centerMolecule(),drawMolecule(s),void 0;for(m=0,b=1;b<=q[0].numatoms;b++)r[a][b]>0&&b!=a&&(o[++m]=b);if(o[0]=m,o[0]!=r[a][0]&&alert("ERROR: Supposed to be "+e+" bonds on atom "+a+", but "+m+" bonds found."),1==atomicNumber){for(f=0,g=0,h=0,b=1;e>=b;b++)c=o[b],dx=q[c].x-q[a].x,dy=q[c].y-q[a].y,dz=q[c].z-q[a].z,dd=Math.sqrt(dx*dx+dy*dy+dz*dz),f+=dx/dd,g+=dy/dd,h+=dz/dd;for(i=Math.sqrt(f*f+g*g+h*h),k=element(1,"radius")+element(q[a].atomicnumber,"radius"),f=q[a].x-f*k/i,g=q[a].y-g*k/i,h=q[a].z-h*k/i,addAtom(1,f,g,h),m=1;e>=m;m++)n=0,j=distance(q,o[m],q[0].numatoms),.2>j&&(n=1);if(n&&e>1)for(b=o[1],c=o[2],f=(q[b].y-q[a].y)*(q[c].z-q[a].z),f-=(q[b].z-q[a].z)*(q[c].y-q[a].y),g=(q[b].z-q[a].z)*(q[c].x-q[a].x),g-=(q[b].x-q[a].x)*(q[c].z-q[a].z),h=(q[b].x-q[a].x)*(q[c].y-q[a].y),h-=(q[b].y-q[a].y)*(q[c].x-q[a].x),i=Math.sqrt(f*f+g*g+h*h),q[q[0].numatoms].x=q[a].x-f*k/i,q[q[0].numatoms].y=q[a].y-g*k/i,q[q[0].numatoms].z=q[a].z-h*k/i,n=0,m=1;e>=m;m++)j=distance(q,o[m],q[0].numatoms),.2>j&&(n=1);return n?(alert("Error adding H atom"),delAtom(q[0].numatoms),void 0):(addBond(a,q[0].numatoms),centerMolecule(),drawMolecule(s),e=0,void 0)}1==e&&(b=a,c=o[1],dx=q[b].x-q[c].x,dy=q[b].y-q[c].y,dz=q[b].z-q[c].z,j=Math.sqrt(dx*dx+dy*dy+dz*dz),k=element(atomicNumber,"radius")+element(q[c].atomicnumber,"radius"),dx*=k/j,dy*=k/j,dz*=k/j,q[b].atomicnumber=atomicNumber,q[b].x=10*dx+q[c].x,q[b].y=dy+q[c].y,q[b].z=dz+q[c].z,addH(a),centerMolecule(),drawMolecule(s)),e>1&&(q[a].atomicnumber=atomicNumber,drawMolecule(s))}function addH(a){var b,d,e,f,g,h,j=parameters(),k=Mol(),l=BondMatrix(),m=activeWin("");if("p"==element(k[a].atomicnumber,"block")&&(d=j.clouds,e=k[a].atomicnumber,valence=element(e,"valence"),f=3+d-valence,1>f&&(d=1),!(1>=d))){for(g=0,b=0;0==g&&b<k[0].numatoms;)b++,l[a][b]>0&&b!=a&&(g=b);if(h=0,g)for(b=0;0==h&&b<k[0].numatoms;)b++,l[g][b]>0&&b!=a&&b!=g&&(h=b);switch(d){case 2:add1H(a,g);break;case 3:add2H(a,g,h,f);break;case 4:add3H(a,g,h,f)}centerMolecule(),drawMolecule(m)}}function add1H(a,b){var d,e,f,h,j,k,l,m=Mol(),g=m[a].atomicnumber,i=element(g,"radius")+element(1,"radius");return 0==b?(d=m[a].x+i,e=m[a].y,f=m[a].z,addAtom(1,j,k,l),addBond(a,m[0].numatoms),void 0):(d=m[b].x-m[a].x,e=m[b].y-m[a].y,f=m[b].z-m[a].z,h=Math.sqrt(d*d+e*e+f*f),j=m[a].x-d*i/h,k=m[a].y-e*i/h,l=m[a].z-f*i/h,addAtom(1,j,k,l),addBond(a,m[0].numatoms),void 0)}function add2H(a,b,c,d){var f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,I,J,G=[],H=Mol(),e=H[a].atomicnumber,h=element(e,"radius")+element(1,"radius");if(0==b)return v=H[a].x+.5*h,w=H[a].y+h*Math.sqrt(3)/2,x=H[a].z,addAtom(1,v,w,x),addBond(a,H[0].numatoms),d>1&&(w=H[a].y-h*Math.sqrt(3)/2,addAtom(1,v,w,x),addBond(a,H[0].numatoms)),void 0;if(f=H[b].atomicnumber,i=H[b].x-H[a].x,j=H[b].y-H[a].y,k=H[b].z-H[a].z,l=Math.sqrt(i*i+j*j+k*k),0==c)for(I=1;I<H[0].numatoms;I++)I!=a&&I!=b&&(c=I,I=H[0].numatoms);return 0==c?(H[a].x=0,H[a].y=0,H[a].z=0,H[b].x=-l,H[b].y=0,H[b].z=0,v=H[a].x+.5*h,w=H[a].y+h*Math.sqrt(3)/2,x=H[a].z,addAtom(1,v,w,x),addBond(a,H[0].numatoms),d>1&&(w=H[a].y-h*Math.sqrt(3)/2,addAtom(1,v,w,x),addBond(a,H[0].numatoms)),void 0):(g=H[c].atomicnumber,m=H[c].x-H[b].x,n=H[c].y-H[b].y,o=H[c].z-H[b].z,p=Math.sqrt(m*m+n*n+o*o),G[0]=i,G[1]=j,G[2]=k,G[3]=-h*l/2,q=(-i*m-j*n-k*o)/(l*p),q=Math.acos(-0.5)+Math.PI-Math.acos(q),G[4]=m,G[5]=n,G[6]=o,G[7]=h*p*Math.cos(q),r=o*j-n*k,s=m*k-o*i,t=n*i-m*j,u=Math.sqrt(r*r+s*s+t*t),G[8]=r,G[9]=s,G[10]=t,G[11]=0,J=gaussElim(G),v=H[a].x+J[0],w=H[a].y+J[1],x=H[a].z+J[2],addAtom(1,v,w,x),addBond(a,H[0].numatoms),1!=d&&(G[0]=i,G[1]=j,G[2]=k,G[3]=-h*l/2,q=(-i*m-j*n-k*o)/(l*p),q=Math.acos(q)-Math.acos(.5),G[4]=m,G[5]=n,G[6]=o,G[7]=h*p*Math.cos(q),G[8]=r,G[9]=s,G[10]=t,G[11]=0,debug="\nRow 1: "+G[0].toFixed(4)+" "+G[1].toFixed(4),debug+=" "+G[2].toFixed(4)+" "+G[3].toFixed(4),debug+="\nRow 2: "+G[4].toFixed(4)+" "+G[5].toFixed(4),debug+=" "+G[6].toFixed(4)+" "+G[7].toFixed(4),debug+="\nRow 3: "+G[8].toFixed(4)+" "+G[9].toFixed(4),debug+=" "+G[10].toFixed(4)+" "+G[11].toFixed(4),J=gaussElim(G),v=H[a].x+J[0],w=H[a].y+J[1],x=H[a].z+J[2],debug="H2 at: ("+v.toFixed(4)+", "+w.toFixed(4)+", "+x.toFixed(4)+")",addAtom(1,v,w,x),addBond(a,H[0].numatoms),debug="atom = "+a+"  i = "+b+"  numatoms = "+H[0].numatoms,debug+="\n"+element(H[H[0].numatoms].atomicnumber,"symbol"),debug+="\nRow 1: "+G[0].toFixed(4)+" "+G[1].toFixed(4),debug+=" "+G[2].toFixed(4)+" "+G[3].toFixed(4),debug+="\nRow 2: "+G[4].toFixed(4)+" "+G[5].toFixed(4),debug+=" "+G[6].toFixed(4)+" "+G[7].toFixed(4),debug+="\nRow 3: "+G[8].toFixed(4)+" "+G[9].toFixed(4),debug+=" "+G[10].toFixed(4)+" "+G[11].toFixed(4),debug+="\nCross: "+r.toFixed(4)+" "+s.toFixed(4)+" "+t.toFixed(4)),void 0)}function add3H(a,b,c,d){var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,I,G=[],H=Mol(),e=H[a].atomicnumber,h=(H[b].atomicnumber,H[c].atomicnumber,element(e,"radius")+element(1,"radius")),i=H[b].x-H[a].x,j=H[b].y-H[a].y,k=H[b].z-H[a].z,l=Math.sqrt(i*i+j*j+k*k);G[0]=i,G[1]=j,G[2]=k,G[3]=-h*l/3,m=H[c].x-H[b].x,n=H[c].y-H[b].y,o=H[c].z-H[b].z,p=Math.sqrt(m*m+n*n+o*o),q=(-i*m-j*n-k*o)/(l*p),q=Math.acos(-1/3)+Math.PI-Math.acos(q),G[4]=m,G[5]=n,G[6]=o,G[7]=h*p*Math.cos(q),r=o*j-n*k,s=m*k-o*i,t=n*i-m*j,u=Math.sqrt(r*r+s*s+t*t),0==u&&(r=H[a].y,s=-H[a].x,t=H[a].z,u=Math.sqrt(r*r+s*s+t*t)),G[8]=r,G[9]=s,G[10]=t,G[11]=0,I=gaussElim(G),v=H[a].x+I[0],w=H[a].y+I[1],x=H[a].z+I[2],addAtom(1,v,w,x),addBond(a,H[0].numatoms),1!=d&&(F=H[0].numatoms,E=h/(3*l),B=H[a].x-i*E,C=H[a].y-j*E,D=H[a].z-k*E,G[0]=H[F].x-B,G[1]=H[F].y-C,G[2]=H[F].z-D,G[3]=4*-h*h/9,y=I[0],z=I[1],A=I[2],G[4]=H[a].x-B,G[5]=H[a].y-C,G[6]=H[a].z-D,G[7]=0,G[8]=r,G[9]=s,G[10]=t,G[11]=h*u*Math.sqrt(2/3),I=gaussElim(G),v=B+I[0],w=C+I[1],x=D+I[2],addAtom(1,v,w,x),addBond(a,H[0].numatoms),2!=d&&(G[0]=H[F].x-B,G[1]=H[F].y-C,G[2]=H[F].z-D,G[3]=4*-h*h/9,y=I[0],z=I[1],A=I[2],G[4]=H[a].x-B,G[5]=H[a].y-C,G[6]=H[a].z-D,G[7]=0,u=Math.sqrt(r*r+s*s+t*t),G[8]=r,G[9]=s,G[10]=t,G[11]=-h*u*Math.sqrt(2/3),debug="atom = "+a+"  i = "+b+"  numatoms = "+H[0].numatoms,debug+="\n"+element(H[H[0].numatoms].atomicnumber,"symbol"),debug+="\nRow 1: "+G[0].toFixed(4)+" "+G[1].toFixed(4),debug+=" "+G[2].toFixed(4)+" "+G[3].toFixed(4),debug+="\nRow 2: "+G[4].toFixed(4)+" "+G[5].toFixed(4),debug+=" "+G[6].toFixed(4)+" "+G[7].toFixed(4),debug+="\nRow 3: "+G[8].toFixed(4)+" "+G[9].toFixed(4),debug+=" "+G[10].toFixed(4)+" "+G[11].toFixed(4),debug+="\nCross: "+r.toFixed(4)+" "+s.toFixed(4)+" "+t.toFixed(4),I=gaussElim(G),v=B+I[0],w=C+I[1],x=D+I[2],addAtom(1,v,w,x),addBond(a,H[0].numatoms)))}function gaussElim(a){var b,c,d,e,f=[],g=parseFloat(a[0]),h=parseFloat(a[1]),i=parseFloat(a[2]),j=parseFloat(a[3]),k=parseFloat(a[4]),l=parseFloat(a[5]),m=parseFloat(a[6]),n=parseFloat(a[7]),o=parseFloat(a[8]),p=parseFloat(a[9]),q=parseFloat(a[10]),r=parseFloat(a[11]);return Math.abs(k)>Math.abs(g)&&Math.abs(k)>Math.abs(o)&&(b=g,c=h,d=i,e=j,g=k,h=l,i=m,j=n,k=b,l=c,m=d,n=e),Math.abs(o)>Math.abs(g)&&Math.abs(o)>Math.abs(k)&&(b=g,c=h,d=i,e=j,g=o,h=p,i=q,j=r,o=b,p=c,q=d,r=e),Math.abs(o)>Math.abs(k)&&(b=k,c=l,d=m,e=n,k=o,l=p,m=q,n=r,o=b,p=c,q=d,r=e),0!=g&&0!=k&&(factor=-g/k,k=0,l=l*factor+h,m=m*factor+i,n=n*factor+j),0!=g&&0!=o&&(factor=-g/o,o=0,p=p*factor+h,q=q*factor+i,r=r*factor+j),Math.abs(p)>Math.abs(l)&&(c=l,d=m,e=n,l=p,m=q,n=r,p=c,q=d,r=e),0!=l&&0!=p&&(factor=-l/p,p=0,q=q*factor+m,r=r*factor+n),f[2]=0,0!=q&&(f[2]=r/q),f[1]=0,0!=l&&(f[1]=(n-m*f[2])/l),f[0]=0,0!=g&&(f[0]=(j-i*f[2]-h*f[1])/g),f}function mechanics(){var a,d,e,f,g,r,h=[],i=[],j=Mol(),k=activeWin(""),l=$(k),m=l.getContext("2d"),n=l.width,o=.2,p=500,q=2e-7;if(Undo("save"),InfoWin("Simple Geometry Optimization starting\n",1),geomLabel(m,"Simple Geometry Optimization started",n),h=hybridization(),r=0,r>0)for(InfoWin("Hybridization\n"),a=1;a<=j[0].numatoms;a++)d=j[a].atomicnumber,InfoWin(element(d,"symbol")+" has "+h[a].hybrid+" hybrid orbitals\n");for(f=mechEnergy(h),h[0].energy=f,h[0].step=o,i[0]=new energyObject,i[0].energy=h[0].energy,i[0].step=h[0].step,a=1;a<=j[0].numatoms;a++)i[a]=new mechanicsObject,i[a].hybrid=h[a].hybrid,i[a].x=h[a].x,i[a].y=h[a].y,i[a].z=h[a].z;for(e=0,g=2*q,InfoWin("0: Energy = "+f.toFixed(8)+"\n");p>e&&g>q;){for(i=optimize(h),g=Math.abs(h[0].energy-i[0].energy),i[0].step>o&&(i[0].step=o),h[0].energy=i[0].energy,h[0].step=i[0].step,a=1;a<=j[0].numatoms;a++)h[a].hybrid=i[a].hybrid,h[a].x=i[a].x,h[a].y=i[a].y,h[a].z=i[a].z;if(e++,3>e&&q>g&&(g=2*q),q>g&&i[0].step<o&&(h[0].step*=1.5,i=optimize(h),g=Math.abs(h[0].energy-i[0].energy),g>q))for(h[0].energy=i[0].energy,h[0].step=i[0].step,a=1;a<=j[0].numatoms;a++)h[a].hybrid=i[a].hybrid,h[a].x=i[a].x,h[a].y=i[a].y,h[a].z=i[a].z;if(InfoWin(e+": Energy = "+i[0].energy.toFixed(8)+"\n"),r=1,r>0&&0==e%5){for(a=1;a<=j[0].numatoms;a++)j[a].x=i[a].x,j[a].y=i[a].y,j[a].z=i[a].z;centerMolecule(),drawMolecule(),geomLabel(m,"Simple Geometry Optimization in progress.",n)}}for(InfoWin("Final Energy at loop "+e+" = "+i[0].energy.toFixed(8)+"\n"),InfoWin("Geometry Optimization complete.\n"),e>=p&&InfoWin("Too many steps. Optimization may not be complete.\n"),a=1;a<=j[0].numatoms;a++)j[a].x=i[a].x,j[a].y=i[a].y,j[a].z=i[a].z;centerMolecule(),drawMolecule()}function mechanicsObject(){this.hybrid=0,this.x=0,this.y=0,this.z=0}function energyObject(){this.energy=0,this.rstep=0,this.astep=0}function distance(a,b,c){var d=a[b].x-a[c].x,e=a[b].y-a[c].y,f=a[b].z-a[c].z,g=Math.sqrt(d*d+e*e+f*f);return g}function angle(a,b,c,d){var e=a[b].x-a[c].x,f=a[b].y-a[c].y,g=a[b].z-a[c].z,h=Math.sqrt(e*e+f*f+g*g),i=a[d].x-a[c].x,j=a[d].y-a[c].y,k=a[d].z-a[c].z,l=Math.sqrt(i*i+j*j+k*k),m=(e*i+f*j+g*k)/(h*l);return m>1&&(m=1),-1>m&&(m=-1),m=180*Math.acos(m)/Math.PI}function dihedral(a,b,c,d,e){var s,t,u,v,i=a[b].x-a[c].x,j=a[b].y-a[c].y,k=a[b].z-a[c].z,l=a[d].x-a[c].x,m=a[d].y-a[c].y,n=a[d].z-a[c].z,p=j*n-k*m,q=k*l-i*n,r=i*m-j*l,o=Math.sqrt(p*p+q*q+r*r);return i=a[e].x-a[d].x,j=a[e].y-a[d].y,k=a[e].z-a[d].z,t=k*m-j*n,u=i*n-k*l,v=j*l-i*m,s=Math.sqrt(t*t+u*u+v*v),ang=(-p*t-q*u-r*v)/(o*s),ang>1&&(ang=1),-1>ang&&(ang=-1),ang=180*Math.acos(ang)/Math.PI}function hybridization(){var a,b,c,d,e=[],f=Mol(),g=BondMatrix();for(e[0]=new energyObject,e[0].energy=0,e[0].step=0,a=1;a<=f[0].numatoms;a++)e[a]=new mechanicsObject,e[a].hybrid=0,e[a].x=f[a].x,e[a].y=f[a].y,e[a].z=f[a].z;for(a=1;a<=f[0].numatoms;a++){switch(d=element(f[a].atomicnumber,"valence")){case 1:case 2:case 3:e[a].hybrid=g[a][0];break;default:e[a].hybrid=d+g[a][0]-4}for(;e[a].hybrid>g[a][0]&&e[a].hybrid>=5;)e[a].hybrid=e[a].hybrid-1}for(a=1;a<=f[0].numatoms;a++)if(4==e[a].hybrid&&g[a][0]<4)for(b=1;b<=f[0].numatoms;b++)c=g[a][b],c>0&&3==e[c].hybrid&&(e[a].hybrid=3);return e}function mechEnergy(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,r,s,u,v,w,x,y,z,A,B,C,L,D=180*Math.acos(-1/3)/Math.PI,E=0,F=Mol(),G=BondMatrix(),H=2e4,I=10,J=5,K=500;if(DEBUG=1,DEBUG>0){for(L=0,b=1;b<=F[0].numatoms;b++)L+=a[b].hybrid;L<F[0].numatoms&&InfoWin("*** Too few hybrid orbitals ("+L+") returned at end of optimize\n")}for(b=1;b<=F[0].numatoms;b++)for(k=element(F[b].atomicnumber,"radius"),3==a[b].hybrid&&(k-=.05),2==a[b].hybrid&&(k-=.1),c=1;c<=F[0].numatoms;c++)G[b][c]>0&&(d=c,l=element(F[d].atomicnumber,"radius"),3==a[d].hybrid&&(l-=.05),2==a[d].hybrid&&(l-=.1),j=k+l,m=a[b].x-a[d].x,n=a[b].y-a[d].y,o=a[b].z-a[d].z,p=Math.sqrt(m*m+n*n+o*o),E+=H*(p-j)*(p-j));for(b=1;b<=F[0].numatoms;b++)if(a[b].hybrid>1)for(c=1;c<F[0].numatoms;c++)if(G[b][c]>0)for(r=c,v=a[r].x-a[b].x,w=a[r].y-a[b].y,x=a[r].z-a[b].z,u=Math.sqrt(v*v+w*w+x*x),d=c+1;d<=F[0].numatoms;d++)if(G[b][d]>0)switch(s=d,z=a[s].x-a[b].x,A=a[s].y-a[b].y,B=a[s].z-a[b].z,y=Math.sqrt(z*z+A*A+B*B),C=(v*z+w*A+x*B)/(u*y),C>1&&(C=1),-1>C&&(C=-1),C=180*Math.acos(C)/Math.PI,a[b].hybrid){case 2:E+=I*(C-180)*(C-180);break;case 3:E+=I*(C-120)*(C-120);break;case 4:E+=I*(C-D)*(C-D);break;case 5:case 6:100>C&&(E+=I*(C-90)*(C-90))}for(b=1;b<F[0].numatoms;b++)if(4==a[b].hybrid)for(e=b+1;e<=F[0].numatoms;e++)if(G[b][e]>0&&4==a[e].hybrid)for(c=e,f=1;f<=F[0].numatoms;f++)if(G[b][f]>0&&f!=c&&f!=b)for(h=f,g=1;g<=F[c].numatoms;g++)if(G[c][g]>0&&g!=c&&g!=b&&g!=h){for(i=F[c].bonds[g],C=Math.abs(dihedral(a,h,b,c,i));C>120;)C-=120;E+=J*(C-60)*(C-60)}for(b=1;b<F[0].numatoms;b++)if(3==a[b].hybrid)for(e=b+1;e<=F[b].numatoms;e++)if(G[b][e]>0&&3==a[c].hybrid)for(c=e,f=1;f<=F[b].numatoms;f++)if(G[b][f]>0&&f!=c&&f!=b)for(h=f,g=1;g<=F[c].numatoms;g++)G[c][g]>0&&g!=b&&g!=c&&g!=h&&(i=g,C=Math.abs(dihedral(a,h,b,c,i)),C>180&&(C-=180),C>135&&(C=180-C),E+=J*C*C);for(b=1;b<F[0].numatoms;b++)for(k=element(F[b].atomicnumber,"radius"),c=b+1;c<=F[0].numatoms;c++)l=element(F[c].atomicnumber,"radius"),p=distance(a,b,c),.1>p&&(p=.1),p/=k+l,E+=K/(p*p*p*p*p*p);return E}function changexyz(a){var c,f,h,i,j,k,l,m,n,o,p,q,r,v,b=Mol(),g=[],t=a[0].step,u=0;if(u>0)for(InfoWin("Hybridization\n"),c=1;c<=b[0].numatoms;c++)Z=b[c].atomicnumber,InfoWin(element(Z,"symbol")+" has "+a[c].hybrid+" hybrid orbitals\n");for(c=0;c<=b[0].numatoms;c++)g[c]=[0,0,0];for(v=[],v[0]=new energyObject,v[0].energy=a[0].energy,v[0].step=a[0].step,c=1;c<=b[0].numatoms;c++)v[c]=new mechanicsObject,v[c].hybrid=a[c].hybrid,v[c].x=a[c].x,v[c].y=a[c].y,v[c].z=a[c].z;for(h=mechEnergy(v),c=1;c<=b[0].numatoms;c++)for(p=v[c].x,q=v[c].y,r=v[c].z,f=0;6>f;f++)switch(l=0,m=0,n=0,i=h,j=h,k=h,o=f%2?1:-1,f){case 0:case 1:for(v[c].x=p+o*t,Energy=mechEnergy(v);Energy>h&&o>.1;)o*=.75,v[c].x=p+o*t,Energy=mechEnergy(v);i>Energy&&(l=o),v[c].x=p,g[c][0]=l*t;break;case 2:case 3:for(v[c].y=q+o*t,Energy=mechEnergy(v);Energy>h&&o>.1;)o*=.75,v[c].y=q+o*t,Energy=mechEnergy(v);j>Energy&&(m=o),v[c].y=q,g[c][1]=m*t;break;case 4:case 5:for(v[c].z=r+o*t,Energy=mechEnergy(v);Energy>h&&o>.1;)o*=.75,v[c].z=r+o*t,Energy=mechEnergy(v);k>Energy&&(n=o),v[c].z=r,g[c][2]=n*t}return g}function optimize(a){var b,c,f,g,h,i,j,k,q,r,s,l=[],m=[],n=Mol(),o=.001;if(a[0].step,q=a[0].energy,DEBUG=1,DEBUG>0){for(r=mechEnergy(a),r!=q&&InfoWin("*** Call to mechEnergy changed energy from "+q+" to "+r+"\n"),s=0,b=1;b<=n[0].numatoms;b++)s+=a[b].hybrid;s<n[0].numatoms&&InfoWin("*** Too few hybrid orbitals ("+s+")\n")}for(b=0;b<=n[0].numatoms;b++)l[b]=[0,0,0];for(l=changexyz(a),k=0,b=0;b<=n[0].numatoms;b++)for(c=0;3>c;c++)Math.abs(l[b][c])>k&&(k=Math.abs(l[b][c]));for(h=a[0].energy,i=0,j=1,g=trialEnergy(a,l,j);g>h&&j>.002;)j*=.75,g=trialEnergy(a,l,j);for(h>g&&(i=j,h=g),f=(i+.5)*(a[0].step+k),o>f&&(f=o),m[0]=new energyObject,m[0].energy=h,m[0].step=f,b=1;b<=n[0].numatoms;b++)m[b]=new mechanicsObject,m[b].hybrid=a[b].hybrid,m[b].x=a[b].x+i*l[b][0],m[b].y=a[b].y+i*l[b][1],m[b].z=a[b].z+i*l[b][2];if(DEBUG=0,DEBUG>0){for(b=0;b<=n[0].numatoms;b++){for(InfoWin("Change in coordinates = ("),c=0;3>c;c++)InfoWin(l[b][c].toFixed(5)),2>c&&InfoWin(", ");InfoWin(")\n")}InfoWin("--- Max change = "+k.toFixed(5)+"\n")}return m}function trialEnergy(a,b,c){var d,e=[],f=Mol();for(e[0]=new energyObject,e[0].energy=a[0].energy,e[0].step=a[0].step,d=1;d<=f[0].numatoms;d++)e[d]=new mechanicsObject,e[d].hybrid=a[d].hybrid,e[d].x=a[d].x+c*b[d][0],e[d].y=a[d].y+c*b[d][1],e[d].z=a[d].z+c*b[d][2];return mechEnergy(e)}var typFF,bontypes,angtypes,dihtypes,imptypes,impCHARMM,atpTip=[],atpLab=[],atpNum=[],atpMas=[],atpChg=[],atpAtm=[],atpSgm=[],atpEps=[],atpAdj=[],bonPar=[],cstPar=[],angPar=[],dihPar=[],defPar=[],keyOPLS=[],$=function(a){return document.getElementById(a)};