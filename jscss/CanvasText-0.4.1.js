function CanvasText(){this.canvasId=null,this.canvas=null,this.context=null,this.bufferCanvas=null,this.bufferContext=null,this.cacheCanvas=[],this.cacheContext=[],this.savedClasses=[],this.fontFamily="Verdana",this.fontWeight="normal",this.fontSize="12px",this.fontColor="#000",this.fontStyle="normal",this.textAlign="start",this.textBaseline="alphabetic",this.lineHeight="16",this.textShadow=null,this.initTime=null,this.endTime=null,this.config=function(a){var b;if("object"!=typeof a)return alert("¡Invalid configuration!"),!1;for(b in a)void 0!==this[b]&&(this[b]=a[b])},this.drawText=function(a){if(this.initTime=(new Date).getTime(),null==this.canvas&&!this.getCanvas())return alert("Incorrect canvas ID!"),!1;if(null==this.bufferCanvas&&this.getBufferCanvas(),void 0!==a.cacheId&&(a.cacheId="ct"+a.cacheId,this.getCache(a.cacheId))){if(a.returnImage){if(a.returnImage)return this.cacheCanvas[a.cacheId]}else this.context.drawImage(this.cacheCanvas[a.cacheId],0,0);return this.endTime=(new Date).getTime(),!1}if("object"!=typeof a)return alert("Invalid text format!"),!1;if(!this.isNumber(a.x)||!this.isNumber(a.y))return alert('You should specify a correct "x" & "y" axis value.'),!1;if(this.bufferCanvas.width=this.bufferCanvas.width,this.bufferContext.fillStyle=this.fontColor,this.bufferContext.font=this.fontWeight+" "+this.fontSize+" "+this.fontFamily,this.drawStyledText(a),void 0!=a.cacheId&&this.setCache(a.cacheId),this.endTime=(new Date).getTime(),a.returnImage){if(a.returnImage)return this.bufferCanvas}else this.context.drawImage(this.bufferCanvas,0,0)},this.drawStyledText=function(a){var e,f,j,k,l,m,n,o,p,q,r,s,t,u,v,y,b=a.text,c=a.x,d=a.y,g=[],h=a.boxWidth,i=[],w=b.match(/<\s*br\s*\/>|<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>|<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>|[^<]+/g),x=null;for(s=0;s<w.length;s++){if(this.bufferContext.save(),p=this.fontColor,i.style=this.fontStyle,i.weight=this.fontWeight,i.size=this.fontSize,i.family=this.fontFamily,r=this.textShadow,/<\s*style=/i.test(w[s])){for(x=w[s].match(/<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>/),j=x[1].split(";"),t=0;t<j.length;t++)if(k=j[t].split(":"),!this.isEmpty(k[0])&&!this.isEmpty(k[1]))switch(l=k[0],m=k[1],l){case"font":i=m;break;case"font-family":i.family=m;break;case"font-weight":i.weight=m;break;case"font-size":i.size=m;break;case"font-style":i.style=m;break;case"text-shadow":r=this.trim(m),r=r.split(" "),4!=r.length&&(r=null);break;case"color":this.isHex(m)&&(p=m)}q=x[2]}else if(/<\s*class=/i.test(w[s])){x=w[s].match(/<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>/),o=this.getClass(x[1]);for(n in o)switch(n){case"font":i=o[n];break;case"fontFamily":i.family=o[n];break;case"fontWeight":i.weight=o[n];break;case"fontSize":i.size=o[n];break;case"fontStyle":i.style=o[n];break;case"fontColor":this.isHex(o[n])&&(p=o[n]);break;case"textShadow":r=this.trim(o[n]),r=r.split(" "),4!=r.length&&(r=null)}q=x[2]}else{if(/<\s*br\s*\/>/i.test(w[s])){d+=1.5*parseInt(this.lineHeight,10),c=a.x;continue}q=w[s]}if(this.bufferContext.textBaseline=this.textBaseline,this.bufferContext.textAlign=this.textAlign,this.bufferContext.font=i instanceof Array?i.style+" "+i.weight+" "+i.size+" "+i.family:i,this.bufferContext.font=i,this.bufferContext.fillStyle=p,null!=r&&(this.bufferContext.shadowOffsetX=r[0].replace("px",""),this.bufferContext.shadowOffsetY=r[1].replace("px",""),this.bufferContext.shadowBlur=r[2].replace("px",""),this.bufferContext.shadowColor=r[3].replace("px","")),g=[],q=q.replace(/\s*\n\s*/g," "),void 0!==h&&this.checkLineBreak(q,h+a.x,c))if(e=this.trim(q).split(" "),1==e.length)g.push({text:this.trim(q)+" ",linebreak:!0});else for(f=c,y=0,g[y]={text:void 0,linebreak:!1},u=0;u<e.length;u++)e[u]+=" ",this.checkLineBreak(e[u],h+a.x,f)?(f=a.x,void 0!==g[y].text&&y++,g[y]={text:e[u],linebreak:!0},f+=this.bufferContext.measureText(e[u]).width):(void 0==g[y].text?g[y].text=e[u]:g[y].text+=e[u],f+=this.bufferContext.measureText(e[u]).width);for(0==g.length&&g.push({text:this.trim(q)+" ",linebreak:!1}),v=0;v<g.length;v++)g[v].linebreak&&(d+=parseInt(this.lineHeight,10),c=a.x),this.bufferContext.fillText(g[v].text,c,d),c+=this.bufferContext.measureText(g[v].text).width;this.bufferContext.restore()}},this.defineClass=function(a,b){return"object"!=typeof b?(alert("¡Invalid class!"),!1):this.isEmpty(a)?(alert("You must specify a Class Name."),!1):(this.savedClasses[a]=b,!0)},this.getClass=function(a){return void 0!==this.savedClasses[a]?this.savedClasses[a]:void 0},this.getCanvas=function(){return null==this.canvasId?(alert("You must specify the canvas ID!"),!1):(this.canvas=document.getElementById(this.canvasId),this.context=this.canvas.getContext("2d"),this.getBufferCanvas(),!0)},this.getBufferCanvas=function(){this.bufferCanvas=document.createElement("canvas"),this.bufferCanvas.width=this.canvas.width,this.bufferCanvas.height=this.canvas.height,this.bufferContext=this.bufferCanvas.getContext("2d")},this.getCache=function(a){return void 0===this.cacheCanvas[a]?!1:!0},this.setCache=function(a){this.cacheCanvas[a]=document.createElement("canvas"),this.cacheCanvas[a].width=this.bufferCanvas.width,this.cacheCanvas[a].height=this.bufferCanvas.height,this.cacheContext[a]=this.cacheCanvas[a].getContext("2d"),this.cacheContext[a].drawImage(this.bufferCanvas,0,0)},this.checkLineBreak=function(a,b,c){return this.bufferContext.measureText(a).width+c>b},this.isHex=function(a){return/^(#[a-fA-F0-9]{3,6})$/i.test(a)},this.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},this.isEmpty=function(a){return a=a.replace(/^\s+|\s+$/,""),0==a.length},this.trim=function(a){var b,c;for(a=a.replace(/^\s\s*/,""),b=/\s/,c=a.length;b.test(a.charAt(--c)););return a.slice(0,c+1)}}